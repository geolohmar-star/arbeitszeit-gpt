{% extends "base.html" %}

{% block title %}Berechtigungen – {{ mitarbeiter.vollname }}{% endblock %}

{% block content %}
<div class="container mt-4" style="max-width: 960px;">

    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{% url 'berechtigungen:uebersicht' %}">Berechtigungsverwaltung</a>
            </li>
            <li class="breadcrumb-item active">{{ mitarbeiter.vollname }}</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <h2 class="mb-0">{{ mitarbeiter.vollname }}</h2>
            <span class="text-muted small">
                {{ mitarbeiter.personalnummer }}
                {% if mitarbeiter.abteilung %}&middot; {{ mitarbeiter.abteilung }}{% endif %}
            </span>
        </div>
        <a href="{% url 'berechtigungen:protokoll' %}?mitarbeiter={{ mitarbeiter.pk }}"
           class="btn btn-outline-secondary btn-sm">
            Protokoll
        </a>
    </div>

    {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    {% endif %}

    <!-- Aktuelle Berechtigungen -->
    <div class="card mb-4">
        <div class="card-header fw-bold d-flex justify-content-between align-items-center">
            Aktuelle Berechtigungen
            <span class="badge bg-secondary fw-normal">{{ users_mit_perms|length }} Nutzer</span>
        </div>
        <div class="card-body p-0">
            {% if users_mit_perms %}
            <table class="table table-sm table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="ps-3">Nutzer</th>
                        <th>Berechtigungen</th>
                        <th class="text-end pe-3">Entziehen</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user, perms in users_mit_perms.items %}
                    <tr>
                        <td class="ps-3 align-middle">
                            <span class="fw-semibold">
                                {{ user.get_full_name|default:user.username }}
                            </span>
                            <span class="text-muted small d-block">{{ user.username }}</span>
                        </td>
                        <td class="align-middle">
                            {% for perm in perms %}
                                <span class="badge bg-light text-dark border me-1">
                                    {% for codename, label in verfuegbare_permissions %}
                                        {% if codename == perm %}{{ label }}{% endif %}
                                    {% endfor %}
                                    {% if perm not in verfuegbare_permissions|dictsort:0 %}
                                        {{ perm }}
                                    {% endif %}
                                </span>
                            {% endfor %}
                        </td>
                        <td class="text-end pe-3 align-middle">
                            {% for perm in perms %}
                            <form method="post"
                                  action="{% url 'berechtigungen:entziehen' mitarbeiter.pk %}"
                                  class="d-inline"
                                  onsubmit="return confirm('Berechtigung entziehen?');">
                                {% csrf_token %}
                                <input type="hidden" name="user_id" value="{{ user.pk }}">
                                <input type="hidden" name="permission" value="{{ perm }}">
                                <button type="submit"
                                        class="btn btn-outline-danger btn-sm mb-1"
                                        title="Entziehen">
                                    {% for codename, label in verfuegbare_permissions %}
                                        {% if codename == perm %}{{ label }}{% endif %}
                                    {% endfor %}
                                    &times;
                                </button>
                            </form>
                            {% endfor %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="px-3 py-4 text-muted small text-center">
                Noch keine Berechtigungen vergeben.
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Neue Berechtigung vergeben -->
    <div class="card">
        <div class="card-header fw-bold">Neue Berechtigung vergeben</div>
        <div class="card-body">
            <form method="post" action="{% url 'berechtigungen:vergeben' mitarbeiter.pk %}">
                {% csrf_token %}
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Nutzer</label>
                        <select name="user_id" class="form-select" required>
                            <option value="">– Nutzer wählen –</option>
                            {% for user in alle_user %}
                            <option value="{{ user.pk }}">
                                {{ user.get_full_name|default:user.username }}
                                ({{ user.username }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Berechtigung</label>
                        <select name="permission" class="form-select" required>
                            <option value="">– Berechtigung wählen –</option>
                            {% for codename, label in verfuegbare_permissions %}
                            <option value="{{ codename }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Bemerkung <span class="text-muted">(optional)</span></label>
                        <input type="text" name="bemerkung" class="form-control"
                               placeholder="z.B. Vertretung bis 31.03.">
                    </div>
                </div>
                <div class="mt-3">
                    <button type="submit" class="btn btn-primary">
                        Berechtigung vergeben
                    </button>
                </div>
            </form>
        </div>
    </div>

</div>
{% endblock %}
