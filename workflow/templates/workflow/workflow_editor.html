{% extends "base.html" %}

{% block title %}Workflow-Editor{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <!-- Toolbar -->
    <div class="card mb-3">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col">
                    <h4 class="mb-0">‚öôÔ∏è Workflow-Editor</h4>
                    <small class="text-muted" id="template-name">Neues Workflow-Template</small>
                </div>
                <div class="col-auto">
                    <button class="btn btn-primary me-2" onclick="showLoadDialog()">
                        üìÇ Template laden
                    </button>
                    <div class="btn-group me-2" role="group">
                        <button class="btn btn-primary" onclick="modus='schritt'; updateModusAnzeige()">
                            ‚ûï Schritt
                        </button>
                        <button class="btn btn-warning" onclick="modus='verbinden'; updateModusAnzeige()">
                            üîó Verbinden
                        </button>
                        <button class="btn btn-danger" onclick="modus='schere'; updateModusAnzeige()">
                            ‚úÇÔ∏è Schere
                        </button>
                        <button class="btn btn-secondary" onclick="modus='bearbeiten'; updateModusAnzeige()">
                            ‚úèÔ∏è Bearbeiten
                        </button>
                    </div>
                    <button class="btn btn-secondary" onclick="zentrieren()">
                        üéØ Zentrieren
                    </button>
                    <button class="btn btn-success" onclick="showSaveDialog()">
                        üíæ Speichern
                    </button>
                    <button class="btn btn-outline-danger" onclick="clearCanvas()">
                        üóëÔ∏è Leeren
                    </button>
                    <a href="{% url 'workflow:arbeitsstapel' %}" class="btn btn-info">
                        üìã Arbeitsstapel
                    </a>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col">
                    <div id="modus-anzeige" class="alert alert-info mb-0 py-2">
                        <strong>Aktueller Modus:</strong> <span id="modus-text">Normaler Modus</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Legende -->
    <div class="card mb-3">
        <div class="card-body py-2">
            <small>
                <strong>Legende:</strong>
                <span class="badge bg-primary ms-2">‚óÜ Genehmigung</span>
                <span class="badge bg-info ms-1">‚óÜ Pruefung</span>
                <span class="badge bg-warning text-dark ms-1">‚óÜ Information</span>
                <span class="badge bg-success ms-1">‚óÜ Bearbeitung</span>
                <br>
                <strong>Bedienung:</strong>
                ‚Ä¢ <strong>‚ûï Schritt</strong> ‚Üí Klick auf Canvas um neuen Schritt zu erstellen
                ‚Ä¢ <strong>üîó Verbinden</strong> ‚Üí Erst Start-, dann Ziel-Schritt klicken
                ‚Ä¢ <strong>‚úÇÔ∏è Schere</strong> ‚Üí Klick auf Linie zum Trennen, Klick auf Schritt zum Loeschen
                ‚Ä¢ <strong>‚úèÔ∏è Bearbeiten</strong> ‚Üí Klick auf Schritt zum Bearbeiten
            </small>
        </div>
    </div>

    <!-- Workflow Canvas -->
    <div class="card">
        <div class="card-body p-0">
            <div id="workflow-network" style="height: 70vh; background: #fafafa;"></div>
        </div>
    </div>
</div>

<!-- Modal: Schritt bearbeiten -->
<div class="modal fade" id="schrittModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="schrittModalTitle">Schritt bearbeiten</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="schrittForm">
                    <input type="hidden" id="schritt-id">

                    <div class="mb-3">
                        <label for="schritt-titel" class="form-label">Titel *</label>
                        <input type="text" class="form-control" id="schritt-titel" required>
                    </div>

                    <div class="mb-3">
                        <label for="schritt-beschreibung" class="form-label">Beschreibung</label>
                        <textarea class="form-control" id="schritt-beschreibung" rows="3"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="schritt-aktion" class="form-label">Aktionstyp *</label>
                            <select class="form-select" id="schritt-aktion" required>
                                <option value="genehmigen">Genehmigen</option>
                                <option value="pruefen">Pruefen</option>
                                <option value="informieren">Informieren</option>
                                <option value="bearbeiten">Bearbeiten</option>
                                <option value="freigeben">Freigeben</option>
                            </select>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="schritt-rolle" class="form-label">Zustaendige Rolle *</label>
                            <select class="form-select" id="schritt-rolle" required onchange="toggleTeamDropdown()">
                                <option value="antragsteller">Antragsteller</option>
                                <option value="direkte_fuehrungskraft">Direkte Fuehrungskraft</option>
                                <option value="abteilungsleitung">Abteilungsleitung</option>
                                <option value="bereichsleitung">Bereichsleitung</option>
                                <option value="hr">HR</option>
                                <option value="gf">Geschaeftsfuehrung</option>
                                <option value="feste_stelle">Feste Stelle</option>
                                <option value="team_queue">Team-Queue</option>
                            </select>
                        </div>
                    </div>

                    <div class="row" id="team-row" style="display: none;">
                        <div class="col-md-12 mb-3">
                            <label for="schritt-team" class="form-label">Team-Queue *</label>
                            <select class="form-select" id="schritt-team">
                                <option value="">-- Team auswaehlen --</option>
                                <!-- Wird via JavaScript gefuellt -->
                            </select>
                            <small class="text-muted">Nur vorhandene Team-Queues koennen ausgewaehlt werden</small>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="schritt-frist" class="form-label">Frist (Tage)</label>
                            <input type="number" class="form-control" id="schritt-frist" value="3" min="0">
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label">Parallel</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="schritt-parallel">
                                <label class="form-check-label" for="schritt-parallel">
                                    Kann parallel laufen
                                </label>
                            </div>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label for="schritt-eskalation" class="form-label">Eskalation (Tage)</label>
                            <input type="number" class="form-control" id="schritt-eskalation" value="0" min="0">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger me-auto" id="schritt-loeschen-btn" onclick="deleteCurrentSchritt()" style="display: none;">
                    üóëÔ∏è Schritt loeschen
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-primary" onclick="saveSchritt()">Speichern</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Template laden -->
<div class="modal fade" id="loadModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Workflow-Template laden</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">Waehlen Sie ein Template um es im Editor zu visualisieren:</p>
                <div id="template-liste" class="list-group">
                    <!-- Wird via JavaScript gefuellt -->
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Laden...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Template speichern -->
<div class="modal fade" id="saveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Workflow-Template speichern</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="saveForm">
                    <!-- Aktueller Workflow Info (wenn geladen) -->
                    <div id="current-template-info" class="alert alert-info" style="display: none;">
                        <strong>Aktueller Workflow:</strong> <span id="current-template-name-display"></span>
                    </div>

                    <!-- Speicher-Modus -->
                    <div class="mb-3" id="save-mode-group" style="display: none;">
                        <label class="form-label">Speichermodus</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="save-mode" id="save-mode-update" value="update" checked>
                            <label class="form-check-label" for="save-mode-update">
                                Bestehendes Template ueberschreiben
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="save-mode" id="save-mode-new" value="new">
                            <label class="form-check-label" for="save-mode-new">
                                Als neues Template speichern
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="template-name-input" class="form-label">Template-Name *</label>
                        <input type="text" class="form-control" id="template-name-input" required>
                    </div>

                    <div class="mb-3">
                        <label for="template-beschreibung" class="form-label">Beschreibung</label>
                        <textarea class="form-control" id="template-beschreibung" rows="3"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="template-kategorie" class="form-label">Kategorie *</label>
                        <select class="form-select" id="template-kategorie" required>
                            <option value="genehmigung">Genehmigung</option>
                            <option value="pruefung">Pruefung</option>
                            <option value="information">Information</option>
                            <option value="bearbeitung">Bearbeitung</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="template-trigger" class="form-label">Trigger-Event (optional)</label>
                        <select class="form-select" id="template-trigger">
                            <option value="">-- Kein automatischer Trigger --</option>
                            <option value="dienstreise_erstellt">Dienstreise erstellt</option>
                            <option value="zag_antrag_erstellt">Z-AG Antrag erstellt</option>
                            <option value="zag_storno_erstellt">Z-AG Stornierung erstellt</option>
                            <option value="aenderung_zeiterfassung_erstellt">Aenderung Zeiterfassung erstellt</option>
                            <option value="zeitgutschrift_erstellt">Zeitgutschrift erstellt</option>
                            <option value="custom">Benutzerdefiniert...</option>
                        </select>
                        <small class="text-muted">Event das diesen Workflow automatisch startet</small>

                        <!-- Custom-Input (erscheint bei "Benutzerdefiniert") -->
                        <input type="text" class="form-control mt-2" id="template-trigger-custom"
                               placeholder="Eigenes Event eingeben..." style="display: none;">
                    </div>

                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="template-aktiv" checked>
                        <label class="form-check-label" for="template-aktiv">
                            Workflow aktiv (kann fuer neue Instanzen verwendet werden)
                        </label>
                    </div>

                    <!-- Zugehoerige Prozesse -->
                    <div id="template-prozesse" class="alert alert-secondary" style="display: none;">
                        <strong>Zugehoeriger Prozess:</strong> <span id="template-prozess-name"></span>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-success" onclick="saveWorkflow()">Speichern</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Edge-Konfiguration -->
<div class="modal fade" id="edgeConfigModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Verbindung konfigurieren</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edge-id">

                <div class="mb-3">
                    <label class="form-label">Von Schritt</label>
                    <input type="text" id="edge-von" class="form-control" readonly>
                </div>

                <div class="mb-3">
                    <label class="form-label">Zu Schritt</label>
                    <input type="text" id="edge-zu" class="form-control" readonly>
                </div>

                <div class="mb-3">
                    <label class="form-label">Bedingung</label>
                    <select id="edge-bedingung-typ" class="form-select" onchange="updateEdgeBedingungFelder()">
                        <option value="immer">Immer (keine Bedingung)</option>
                        <option value="entscheidung">Basierend auf Task-Entscheidung</option>
                        <option value="feld_wert">Basierend auf Feld-Wert</option>
                        <option value="python">Custom Python-Code</option>
                    </select>
                </div>

                <!-- Felder fuer bedingung_typ == "entscheidung" -->
                <div id="edge-bedingung-entscheidung-container" style="display:none;" class="mb-3">
                    <label class="form-label">Erwartete Entscheidung</label>
                    <select id="edge-bedingung-entscheidung" class="form-select">
                        <option value="genehmigt">Genehmigt</option>
                        <option value="abgelehnt">Abgelehnt</option>
                        <option value="weitergeleitet">Weitergeleitet</option>
                        <option value="rueckfrage">Rueckfrage</option>
                        <option value="zurueck_genehmiger">Zurueck zum Genehmiger</option>
                        <option value="zurueck_antragsteller">Zurueck zum Antragsteller</option>
                    </select>
                </div>

                <!-- Felder fuer bedingung_typ == "feld_wert" -->
                <div id="edge-bedingung-feld-container" style="display:none;">
                    <div class="mb-3">
                        <label class="form-label">Feld-Name</label>
                        <input type="text" id="edge-bedingung-feld" class="form-control" placeholder="z.B. geschaetzte_kosten">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Operator</label>
                        <select id="edge-bedingung-operator" class="form-select">
                            <option value="==">Gleich (==)</option>
                            <option value="!=">Ungleich (!=)</option>
                            <option value=">">Groesser als (>)</option>
                            <option value="<">Kleiner als (<)</option>
                            <option value=">=">Groesser oder gleich (>=)</option>
                            <option value="<=">Kleiner oder gleich (<=)</option>
                            <option value="in">Enthalten in (in)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Wert</label>
                        <input type="text" id="edge-bedingung-wert" class="form-control" placeholder="z.B. 1000">
                    </div>
                </div>

                <!-- Felder fuer bedingung_typ == "python" -->
                <div id="edge-bedingung-python-container" style="display:none;" class="mb-3">
                    <label class="form-label">Python-Code</label>
                    <textarea id="edge-bedingung-python-code" class="form-control" rows="4"
                              placeholder="z.B. content_object.betrag > 1000"></textarea>
                    <small class="text-muted">Verfuegbare Variablen: task, instance, content_object</small>
                </div>

                <div class="mb-3">
                    <label class="form-label">Label (optional)</label>
                    <input type="text" id="edge-label" class="form-control" placeholder="z.B. genehmigt, abgelehnt">
                </div>

                <div class="mb-3">
                    <label class="form-label">Prioritaet</label>
                    <input type="number" id="edge-prioritaet" class="form-control" value="1" min="1">
                    <small class="text-muted">Bei mehreren zutreffenden Bedingungen wird die hoehere Prioritaet gewaehlt</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger me-auto" onclick="deleteEdgeFromModal()">
                    Verbindung loeschen
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-primary" onclick="saveEdgeConfig()">Speichern</button>
            </div>
        </div>
    </div>
</div>

<!-- vis.js Library (lokal fuer Offline-Betrieb) -->
<!-- TODO: vis.js von https://unpkg.com/vis-network@9.1.9/standalone/umd/vis-network.min.js herunterladen -->
<!-- und nach static/js/vis-network.min.js kopieren -->
{% load static %}
<script src="{% static 'js/vis-network.min.js' %}"></script>

<script>
// Globale Variablen
let network;
let nodes, edges;
let modus = 'normal';
let verbindungStart = null;
let nextNodeId = 1;
let currentEditNode = null;
let currentTemplateId = null;
let currentTemplateName = '';
let currentTemplateAktiv = false;

// Schritt-Daten (wird beim Speichern ans Backend geschickt)
let schritte = [];

// NEU: Edge-Konfigurationen (fuer Graph-Workflows)
let edgeConfigs = [];

// Aktionstyp zu Farbe (hellere Farben fuer bessere Lesbarkeit)
const aktionColors = {
    'genehmigen': '#66b3ff',  // Hellblau
    'pruefen': '#66d9ef',     // Hellcyan
    'informieren': '#ffe066', // Hellgelb
    'bearbeiten': '#66cc99',  // Hellgruen
    'freigeben': '#b3b3b3'    // Hellgrau
};

// Netzwerk initialisieren
function init() {
    const container = document.getElementById('workflow-network');

    nodes = new vis.DataSet([]);
    edges = new vis.DataSet([]);

    const options = {
        nodes: {
            shape: 'diamond',
            size: 30,
            font: {
                size: 16,
                color: '#000',
                face: 'Arial'
            },
            borderWidth: 2,
            shadow: true
        },
        edges: {
            width: 2,
            shadow: true,
            arrows: 'to',
            smooth: {
                type: 'cubicBezier',
                forceDirection: 'horizontal'
            }
        },
        layout: {
            hierarchical: false  // Wird nur beim Laden aktiviert
        },
        physics: {
            enabled: false  // Physics deaktiviert fuer manuelles Positionieren
        },
        interaction: {
            dragNodes: true,
            dragView: true,
            zoomView: true
        }
    };

    network = new vis.Network(container, { nodes, edges }, options);

    // Event-Handler
    network.on('click', handleClick);
    network.on('doubleClick', handleDoubleClick);

    // Antrag-Startknoten hinzufuegen
    createAntragNode();
}

// Erstelle den "Antrag" Start-Knoten
function createAntragNode() {
    // Pruefe ob Antrag-Knoten schon existiert
    if (nodes.get('antrag_start')) {
        return;
    }

    nodes.add({
        id: 'antrag_start',
        label: 'üìã Antrag\n(Antragsteller)',
        shape: 'box',
        color: {
            background: '#e3f2fd',
            border: '#1976d2',
            highlight: {
                background: '#bbdefb',
                border: '#0d47a1'
            }
        },
        font: {
            size: 14,
            color: '#0d47a1',
            bold: true
        },
        fixed: false,
        x: -300,
        y: 0,
        borderWidth: 3,
        margin: 10
    });
}

// Klick-Handler
function handleClick(params) {
    if (modus === 'schritt') {
        // Neuen Schritt erstellen
        if (params.nodes.length === 0) {
            createNewSchritt(params.pointer.canvas);
        }
    } else if (modus === 'verbinden') {
        // Verbindung erstellen
        if (params.nodes.length > 0) {
            const clickedNode = params.nodes[0];
            if (verbindungStart === null) {
                verbindungStart = clickedNode;
                // Kein Alert mehr - visuelle R√ºckmeldung durch Modus-Anzeige
            } else {
                createEdge(verbindungStart, clickedNode);
                verbindungStart = null;
            }
        }
    } else if (modus === 'schere') {
        // Loeschen
        if (params.nodes.length > 0) {
            deleteNode(params.nodes[0]);
        } else if (params.edges.length > 0) {
            deleteEdge(params.edges[0]);
        }
    } else if (modus === 'bearbeiten') {
        // Schritt bearbeiten
        if (params.nodes.length > 0) {
            editSchritt(params.nodes[0]);
        }
    }
}

// Neuen Schritt erstellen
function createNewSchritt(position) {
    currentEditNode = null;
    document.getElementById('schritt-id').value = '';
    document.getElementById('schritt-titel').value = '';
    document.getElementById('schritt-beschreibung').value = '';
    document.getElementById('schritt-aktion').value = 'genehmigen';
    document.getElementById('schritt-rolle').value = 'direkte_fuehrungskraft';
    document.getElementById('schritt-team').value = '';
    document.getElementById('schritt-frist').value = '3';
    document.getElementById('schritt-parallel').checked = false;
    document.getElementById('schritt-eskalation').value = '0';

    // Team-Dropdown ausblenden (default Rolle ist nicht team_queue)
    toggleTeamDropdown();

    // Loeschen-Button verstecken (nur beim Bearbeiten)
    document.getElementById('schritt-loeschen-btn').style.display = 'none';

    document.getElementById('schrittModalTitle').textContent = 'Neuen Schritt erstellen';

    const modal = new bootstrap.Modal(document.getElementById('schrittModal'));
    modal.show();
}

// Schritt speichern
function saveSchritt() {
    const id = document.getElementById('schritt-id').value;
    const titel = document.getElementById('schritt-titel').value;
    const beschreibung = document.getElementById('schritt-beschreibung').value;
    const aktion = document.getElementById('schritt-aktion').value;
    const rolle = document.getElementById('schritt-rolle').value;
    const teamId = document.getElementById('schritt-team').value;
    const frist = parseInt(document.getElementById('schritt-frist').value);
    const parallel = document.getElementById('schritt-parallel').checked;
    const eskalation = parseInt(document.getElementById('schritt-eskalation').value);

    if (!titel) {
        alert('Bitte einen Titel eingeben!');
        return;
    }

    // Validierung: Team-Queue Rolle benoetigt Team-Auswahl
    if (rolle === 'team_queue' && !teamId) {
        alert('Bitte ein Team auswaehlen!');
        return;
    }

    const color = aktionColors[aktion] || '#6c757d';

    // Team-Name fuer Anzeige holen
    let displayRolle = rolle;
    if (rolle === 'team_queue' && teamId) {
        const teamSelect = document.getElementById('schritt-team');
        const teamOption = teamSelect.options[teamSelect.selectedIndex];
        displayRolle = `Team: ${teamOption.text}`;
    }

    if (id) {
        // Bestehenden Schritt aktualisieren
        nodes.update({
            id: id,
            label: titel,
            title: `${titel}\n${aktion}\n${displayRolle}`,
            color: {
                background: color,
                border: color,
                highlight: { background: color, border: color }
            },
            data: {
                titel, beschreibung, aktion, rolle, teamId, frist, parallel, eskalation
            }
        });

        // In schritte-Array aktualisieren
        const idx = schritte.findIndex(s => s.id === id);
        if (idx >= 0) {
            schritte[idx] = { id, titel, beschreibung, aktion, rolle, teamId, frist, parallel, eskalation };
        }
    } else {
        // Neuen Schritt hinzufuegen
        const nodeId = `node_${nextNodeId++}`;
        nodes.add({
            id: nodeId,
            label: titel,
            title: `${titel}\n${aktion}\n${displayRolle}`,
            color: {
                background: color,
                border: color,
                highlight: { background: color, border: color }
            },
            data: {
                titel, beschreibung, aktion, rolle, teamId, frist, parallel, eskalation
            }
        });

        schritte.push({ id: nodeId, titel, beschreibung, aktion, rolle, teamId, frist, parallel, eskalation });
    }

    bootstrap.Modal.getInstance(document.getElementById('schrittModal')).hide();
}

// Schritt bearbeiten
function editSchritt(nodeId) {
    const node = nodes.get(nodeId);
    if (!node) return;

    const data = node.data || {};

    currentEditNode = nodeId;
    document.getElementById('schritt-id').value = nodeId;
    document.getElementById('schritt-titel').value = data.titel || node.label;
    document.getElementById('schritt-beschreibung').value = data.beschreibung || '';
    document.getElementById('schritt-aktion').value = data.aktion || 'genehmigen';
    document.getElementById('schritt-rolle').value = data.rolle || 'direkte_fuehrungskraft';
    document.getElementById('schritt-team').value = data.teamId || '';
    document.getElementById('schritt-frist').value = data.frist || 3;
    document.getElementById('schritt-parallel').checked = data.parallel || false;
    document.getElementById('schritt-eskalation').value = data.eskalation || 0;

    // Team-Dropdown ein/ausblenden
    toggleTeamDropdown();

    // Loeschen-Button anzeigen (beim Bearbeiten)
    document.getElementById('schritt-loeschen-btn').style.display = 'block';

    document.getElementById('schrittModalTitle').textContent = 'Schritt bearbeiten';

    const modal = new bootstrap.Modal(document.getElementById('schrittModal'));
    modal.show();
}

// Verbindung erstellen
function createEdge(fromId, toId) {
    if (fromId === toId) {
        alert('Ein Schritt kann nicht mit sich selbst verbunden werden!');
        return;
    }

    // Pruefe ob Verbindung bereits existiert
    const existingEdges = edges.get({
        filter: edge => edge.from === fromId && edge.to === toId
    });

    if (existingEdges.length > 0) {
        alert('Diese Verbindung existiert bereits!');
        return;
    }

    edges.add({
        id: `edge_${fromId}_${toId}`,
        from: fromId,
        to: toId
    });

    // Kein Alert mehr - Verbindung ist visuell sichtbar
}

// Node loeschen
function deleteNode(nodeId) {
    // Verhindere Loeschen des Antrag-Knotens
    if (nodeId === 'antrag_start') {
        alert('Der Antrag-Startknoten kann nicht geloescht werden.');
        return;
    }

    if (confirm(`Schritt "${nodes.get(nodeId).label}" wirklich loeschen?`)) {
        // Entferne aus schritte-Array
        schritte = schritte.filter(s => s.id !== nodeId);

        // Entferne alle verbundenen Edges
        const connectedEdges = edges.get({
            filter: edge => edge.from === nodeId || edge.to === nodeId
        });
        connectedEdges.forEach(edge => edges.remove(edge.id));

        // Entferne Node
        nodes.remove(nodeId);
    }
}

// Aktuell bearbeiteten Schritt loeschen (aus Modal)
function deleteCurrentSchritt() {
    const nodeId = document.getElementById('schritt-id').value;

    if (!nodeId) {
        alert('Kein Schritt zum Loeschen ausgewaehlt.');
        return;
    }

    // Verhindere Loeschen des Antrag-Knotens
    if (nodeId === 'antrag_start') {
        alert('Der Antrag-Startknoten kann nicht geloescht werden.');
        return;
    }

    if (confirm(`Schritt "${nodes.get(nodeId).label}" wirklich loeschen?`)) {
        // Entferne aus schritte-Array
        schritte = schritte.filter(s => s.id !== nodeId);

        // Entferne alle verbundenen Edges
        const connectedEdges = edges.get({
            filter: edge => edge.from === nodeId || edge.to === nodeId
        });
        connectedEdges.forEach(edge => edges.remove(edge.id));

        // Entferne Node
        nodes.remove(nodeId);

        // Schliesse Modal
        bootstrap.Modal.getInstance(document.getElementById('schrittModal')).hide();
    }
}

// Edge loeschen
function deleteEdge(edgeId) {
    if (confirm('Verbindung wirklich loeschen?')) {
        edges.remove(edgeId);
    }
}

// Zentrieren
function zentrieren() {
    network.fit();
}

// Modus-Anzeige aktualisieren
function updateModusAnzeige() {
    const modusTexte = {
        'normal': 'Normaler Modus',
        'schritt': '‚ûï Schritt hinzufuegen - Klick auf Canvas',
        'verbinden': 'üîó Verbinden - Erst Start-, dann Ziel-Schritt klicken',
        'schere': '‚úÇÔ∏è Schere - Klick auf Schritt oder Verbindung zum Loeschen',
        'bearbeiten': '‚úèÔ∏è Bearbeiten - Klick auf Schritt zum Bearbeiten'
    };

    document.getElementById('modus-text').textContent = modusTexte[modus] || 'Unbekannt';

    verbindungStart = null;
}

// Speichern-Dialog anzeigen
function showSaveDialog() {
    if (nodes.length === 0) {
        alert('Bitte erst Schritte erstellen!');
        return;
    }

    // Felder vorausfuellen wenn Template geladen wurde
    if (currentTemplateId) {
        // Zeige Info-Box mit aktuellem Template
        document.getElementById('current-template-info').style.display = 'block';
        document.getElementById('current-template-name-display').textContent = currentTemplateName;

        // Zeige Speichermodus-Optionen
        document.getElementById('save-mode-group').style.display = 'block';

        // Vorausfuellen
        document.getElementById('template-name-input').value = currentTemplateName;
        document.getElementById('template-aktiv').checked = currentTemplateAktiv;

        // Radio button auf "update" setzen
        document.getElementById('save-mode-update').checked = true;
    } else {
        // Neues Template - verstecke Speichermodus
        document.getElementById('current-template-info').style.display = 'none';
        document.getElementById('save-mode-group').style.display = 'none';
        document.getElementById('template-name-input').value = '';
        document.getElementById('template-aktiv').checked = true;
    }

    const modal = new bootstrap.Modal(document.getElementById('saveModal'));
    modal.show();
}

// Workflow speichern
async function saveWorkflow() {
    const name = document.getElementById('template-name-input').value;
    const beschreibung = document.getElementById('template-beschreibung').value;
    const kategorie = document.getElementById('template-kategorie').value;
    let trigger = document.getElementById('template-trigger').value;
    const aktiv = document.getElementById('template-aktiv').checked;

    // Custom-Trigger verarbeiten
    if (trigger === 'custom') {
        const customTrigger = document.getElementById('template-trigger-custom').value.trim();
        if (!customTrigger) {
            alert('Bitte ein benutzerdefiniertes Event eingeben!');
            return;
        }
        trigger = customTrigger;
    }

    // Leeren Trigger auf null setzen
    if (!trigger) {
        trigger = null;
    }

    if (!name) {
        alert('Bitte einen Template-Namen eingeben!');
        return;
    }

    // Pruefe Speichermodus (update oder new)
    let saveMode = 'new';
    let templateIdToUpdate = null;

    if (currentTemplateId) {
        const saveModeRadio = document.querySelector('input[name="save-mode"]:checked');
        saveMode = saveModeRadio ? saveModeRadio.value : 'new';

        if (saveMode === 'update') {
            templateIdToUpdate = currentTemplateId;
        }
    }

    // Reihenfolge berechnen (topologische Sortierung basierend auf Edges)
    const schritteMitReihenfolge = calculateReihenfolge();

    // Edges sammeln (alle Verbindungen, auch vom Antrag-Knoten)
    const allEdges = edges.get().map(edge => {
        const config = edgeConfigs.find(c => c.edgeId === edge.id);
        return {
            from: edge.from,
            to: edge.to,
            config: config || {bedingung_typ: 'immer'}
        };
    });

    const data = {
        template: {
            name,
            beschreibung,
            kategorie,
            trigger_event: trigger,
            aktiv: aktiv,
            template_id: templateIdToUpdate  // null wenn neu, sonst ID zum Update
        },
        schritte: schritteMitReihenfolge,
        edges: allEdges,  // Edges mit Konfigurationen
        ist_graph_workflow: edgeConfigs.length > 0  // NEU: Flag setzen wenn Edge-Configs existieren
    };

    try {
        const response = await fetch('/workflow/editor/save/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            const result = await response.json();
            // Erfolgsmeldung in der Modus-Anzeige
            document.getElementById('modus-text').innerHTML = `<span class="text-success">‚úì Workflow "${name}" erfolgreich gespeichert!</span>`;
            bootstrap.Modal.getInstance(document.getElementById('saveModal')).hide();

            // Template-Info aktualisieren
            currentTemplateId = result.template_id;
            document.getElementById('template-name').textContent = name;
        } else {
            const error = await response.json();
            alert(`Fehler beim Speichern: ${error.error || 'Unbekannter Fehler'}`);
        }
    } catch (error) {
        alert(`Fehler beim Speichern: ${error.message}`);
    }
}

// Reihenfolge berechnen
function calculateReihenfolge() {
    // Einfache Strategie: Breadth-First von Nodes ohne eingehende Edges
    const allEdges = edges.get();
    const allNodes = nodes.get();

    const inDegree = {};
    allNodes.forEach(n => inDegree[n.id] = 0);
    allEdges.forEach(e => {
        if (inDegree[e.to] !== undefined) {
            inDegree[e.to]++;
        }
    });

    const queue = allNodes.filter(n => inDegree[n.id] === 0);
    const sorted = [];
    let reihenfolge = 1;

    while (queue.length > 0) {
        const node = queue.shift();
        const schrittData = schritte.find(s => s.id === node.id);
        if (schrittData) {
            sorted.push({ ...schrittData, reihenfolge: reihenfolge++ });
        }

        // Reduziere inDegree fuer alle Nachfolger
        allEdges.filter(e => e.from === node.id).forEach(e => {
            inDegree[e.to]--;
            if (inDegree[e.to] === 0) {
                const nextNode = allNodes.find(n => n.id === e.to);
                if (nextNode) queue.push(nextNode);
            }
        });
    }

    // Falls nicht alle Nodes sortiert wurden (Zyklen), fuege sie am Ende hinzu
    schritte.forEach(s => {
        if (!sorted.find(x => x.id === s.id)) {
            sorted.push({ ...s, reihenfolge: reihenfolge++ });
        }
    });

    return sorted;
}

// Template laden Dialog anzeigen
async function showLoadDialog() {
    const modal = new bootstrap.Modal(document.getElementById('loadModal'));
    modal.show();

    // Templates vom Server laden
    try {
        const response = await fetch('/workflow/editor/templates/');
        const data = await response.json();

        const container = document.getElementById('template-liste');
        container.innerHTML = '';

        if (data.templates.length === 0) {
            container.innerHTML = '<div class="alert alert-info">Keine Templates vorhanden.</div>';
            return;
        }

        data.templates.forEach(t => {
            const item = document.createElement('a');
            item.href = '#';
            item.className = 'list-group-item list-group-item-action';
            item.innerHTML = `
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${t.name}</h6>
                    <small>${t.ist_aktiv ? '<span class="badge bg-success">Aktiv</span>' : '<span class="badge bg-secondary">Inaktiv</span>'}</small>
                </div>
                <p class="mb-1 small text-muted">Kategorie: ${t.kategorie} | Schritte: ${t.schritte_anzahl}</p>
            `;
            item.onclick = (e) => {
                e.preventDefault();
                loadTemplate(t.id);
                modal.hide();
            };
            container.appendChild(item);
        });
    } catch (error) {
        document.getElementById('template-liste').innerHTML =
            `<div class="alert alert-danger">Fehler beim Laden: ${error.message}</div>`;
    }
}

// Template vom Server laden und visualisieren
async function loadTemplate(templateId) {
    try {
        const response = await fetch(`/workflow/editor/load/${templateId}/`);
        const data = await response.json();

        // Globale Template-Variablen setzen
        currentTemplateId = templateId;
        currentTemplateName = data.template.name;
        currentTemplateAktiv = data.template.ist_aktiv || false;

        // Template-Info anzeigen
        document.getElementById('template-name').textContent = data.template.name;

        // Canvas leeren
        nodes.clear();
        edges.clear();
        schritte = [];
        edgeConfigs = [];

        // Nodes hinzufuegen (gleiche Farben wie oben)
        const aktionColors = {
            'genehmigen': '#66b3ff',
            'pruefen': '#66d9ef',
            'informieren': '#ffe066',
            'bearbeiten': '#66cc99',
            'freigeben': '#b3b3b3'
        };

        // Berechne feste Positionen basierend auf Reihenfolge
        const startX = 200;
        const startY = 300;
        const spacingX = 350;  // Horizontaler Abstand
        const spacingY = 150;  // Vertikaler Abstand fuer mehrere Ebenen

        data.nodes.forEach((nodeData, index) => {
            const nodeId = nodeData.id;
            const color = aktionColors[nodeData.aktion] || '#6c757d';

            // Position basierend auf Reihenfolge
            const xPos = startX + (nodeData.reihenfolge - 1) * spacingX;
            const yPos = startY + (index % 3) * spacingY;  // 3 Ebenen vertikal

            nodes.add({
                id: nodeId,
                label: nodeData.titel,
                title: `${nodeData.titel}\\n${nodeData.aktion}\\n${nodeData.rolle}`,
                color: {
                    background: color,
                    border: color,
                    highlight: { background: color, border: color }
                },
                x: xPos,
                y: yPos,
                fixed: { x: false, y: false },  // Nodes sind verschiebbar
                physics: false,  // Keine Physics-Simulation fuer diesen Node
                data: nodeData
            });

            schritte.push({
                id: nodeId,
                titel: nodeData.titel,
                beschreibung: nodeData.beschreibung,
                aktion: nodeData.aktion,
                rolle: nodeData.rolle,
                frist: nodeData.frist,
                parallel: nodeData.parallel,
                eskalation: nodeData.eskalation,
                reihenfolge: nodeData.reihenfolge
            });
        });

        // Edges hinzufuegen (falls vorhanden im Template)
        if (data.edges && data.edges.length > 0) {
            data.edges.forEach(edgeData => {
                const edgeId = `edge_${edgeData.from}_${edgeData.to}`;
                edges.add({
                    id: edgeId,
                    from: edgeData.from,
                    to: edgeData.to,
                    label: edgeData.config?.label || ''
                });

                // Edge-Konfiguration wiederherstellen
                if (edgeData.config) {
                    edgeConfigs.push({
                        edgeId: edgeId,
                        ...edgeData.config
                    });
                }
            });
        } else {
            // Automatische Edges erstellen basierend auf Reihenfolge
            // Sortiere Nodes nach Reihenfolge
            const sortedNodes = [...data.nodes].sort((a, b) => a.reihenfolge - b.reihenfolge);

            // Verbinde aufeinanderfolgende Schritte
            for (let i = 0; i < sortedNodes.length - 1; i++) {
                edges.add({
                    id: `edge_${sortedNodes[i].id}_${sortedNodes[i + 1].id}`,
                    from: sortedNodes[i].id,
                    to: sortedNodes[i + 1].id
                });
            }

            // Verbinde Antrag-Knoten mit erstem Schritt
            if (sortedNodes.length > 0) {
                edges.add({
                    id: `edge_antrag_start_${sortedNodes[0].id}`,
                    from: 'antrag_start',
                    to: sortedNodes[0].id
                });
            }
        }

        // nextNodeId auf naechste freie ID setzen
        const maxId = Math.max(...data.nodes.map(n => {
            const match = n.id.match(/node_(\d+)/);
            return match ? parseInt(match[1]) : 0;
        }), 0);
        nextNodeId = maxId + 1;

        // Antrag-Startknoten hinzufuegen
        createAntragNode();

        // Zentrieren
        setTimeout(() => {
            network.fit();
        }, 100);

        alert(`Template "${data.template.name}" erfolgreich geladen!`);
    } catch (error) {
        alert(`Fehler beim Laden: ${error.message}`);
    }
}

// Canvas leeren
function clearCanvas() {
    if (confirm('Canvas wirklich leeren? Alle Schritte werden geloescht.')) {
        nodes.clear();
        edges.clear();
        schritte = [];
        edgeConfigs = [];
        nextNodeId = 1;
        document.getElementById('template-name').textContent = 'Neues Workflow-Template';

        // Antrag-Startknoten wieder hinzufuegen
        createAntragNode();
    }
}

// === NEU: Edge-Konfigurations-Funktionen (Graph-Workflows) ===

// Doppelklick-Handler fuer Edge-Konfiguration
function handleDoubleClick(params) {
    if (params.edges.length === 1) {
        const edgeId = params.edges[0];
        const edge = edges.get(edgeId);
        if (edge) {
            openEdgeConfigModal(edge);
        }
    }
}

// Edge-Konfigurations-Modal oeffnen
function openEdgeConfigModal(edge) {
    const fromNode = nodes.get(edge.from);
    const toNode = nodes.get(edge.to);

    document.getElementById('edge-id').value = edge.id;
    document.getElementById('edge-von').value = fromNode ? fromNode.label : 'Unbekannt';
    document.getElementById('edge-zu').value = toNode ? toNode.label : 'Unbekannt';

    // Lade bestehende Konfiguration
    const config = edgeConfigs.find(c => c.edgeId === edge.id) || {};
    document.getElementById('edge-bedingung-typ').value = config.bedingung_typ || 'immer';
    document.getElementById('edge-bedingung-entscheidung').value = config.bedingung_entscheidung || 'genehmigt';
    document.getElementById('edge-bedingung-feld').value = config.bedingung_feld || '';
    document.getElementById('edge-bedingung-operator').value = config.bedingung_operator || '==';
    document.getElementById('edge-bedingung-wert').value = config.bedingung_wert || '';
    document.getElementById('edge-bedingung-python-code').value = config.bedingung_python_code || '';
    document.getElementById('edge-label').value = config.label || '';
    document.getElementById('edge-prioritaet').value = config.prioritaet || 1;

    updateEdgeBedingungFelder();

    const modal = new bootstrap.Modal(document.getElementById('edgeConfigModal'));
    modal.show();
}

// Edge-Bedingungsfelder ein/ausblenden
function updateEdgeBedingungFelder() {
    const typ = document.getElementById('edge-bedingung-typ').value;

    document.getElementById('edge-bedingung-entscheidung-container').style.display =
        typ === 'entscheidung' ? 'block' : 'none';
    document.getElementById('edge-bedingung-feld-container').style.display =
        typ === 'feld_wert' ? 'block' : 'none';
    document.getElementById('edge-bedingung-python-container').style.display =
        typ === 'python' ? 'block' : 'none';
}

// Edge-Konfiguration speichern
function saveEdgeConfig() {
    const edgeId = document.getElementById('edge-id').value;
    const bedingung_typ = document.getElementById('edge-bedingung-typ').value;

    const config = {
        edgeId: edgeId,
        bedingung_typ: bedingung_typ,
        bedingung_entscheidung: document.getElementById('edge-bedingung-entscheidung').value,
        bedingung_feld: document.getElementById('edge-bedingung-feld').value,
        bedingung_operator: document.getElementById('edge-bedingung-operator').value,
        bedingung_wert: document.getElementById('edge-bedingung-wert').value,
        bedingung_python_code: document.getElementById('edge-bedingung-python-code').value,
        label: document.getElementById('edge-label').value,
        prioritaet: parseInt(document.getElementById('edge-prioritaet').value) || 1
    };

    // Aktualisiere oder fuege hinzu
    const index = edgeConfigs.findIndex(c => c.edgeId === edgeId);
    if (index >= 0) {
        edgeConfigs[index] = config;
    } else {
        edgeConfigs.push(config);
    }

    // Aktualisiere Edge-Label im Graph
    if (config.label) {
        edges.update({id: edgeId, label: config.label});
    } else {
        edges.update({id: edgeId, label: ''});
    }

    bootstrap.Modal.getInstance(document.getElementById('edgeConfigModal')).hide();
}

// Edge aus Modal loeschen
function deleteEdgeFromModal() {
    const edgeId = document.getElementById('edge-id').value;
    if (confirm('Verbindung wirklich loeschen?')) {
        edges.remove(edgeId);
        edgeConfigs = edgeConfigs.filter(c => c.edgeId !== edgeId);
        bootstrap.Modal.getInstance(document.getElementById('edgeConfigModal')).hide();
    }
}

// Team-Queue Funktionen
function toggleTeamDropdown() {
    const rolle = document.getElementById('schritt-rolle').value;
    const teamRow = document.getElementById('team-row');

    if (rolle === 'team_queue') {
        teamRow.style.display = 'block';
        document.getElementById('schritt-team').required = true;
    } else {
        teamRow.style.display = 'none';
        document.getElementById('schritt-team').required = false;
        document.getElementById('schritt-team').value = '';
    }
}

async function loadTeamQueues() {
    try {
        const response = await fetch('/formulare/api/team-queues/');
        const data = await response.json();

        const select = document.getElementById('schritt-team');
        // Bestehende Optionen loeschen (ausser erste)
        select.innerHTML = '<option value="">-- Team auswaehlen --</option>';

        data.teams.forEach(team => {
            const option = document.createElement('option');
            option.value = team.id;
            option.textContent = team.name;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Fehler beim Laden der Team-Queues:', error);
    }
}

// Trigger-Event Custom-Feld ein/ausblenden
function toggleTriggerCustom() {
    const triggerSelect = document.getElementById('template-trigger');
    const customInput = document.getElementById('template-trigger-custom');

    if (triggerSelect.value === 'custom') {
        customInput.style.display = 'block';
        customInput.required = true;
    } else {
        customInput.style.display = 'none';
        customInput.required = false;
        customInput.value = '';
    }
}

// Init beim Laden
document.addEventListener('DOMContentLoaded', () => {
    init();
    loadTeamQueues();

    // Event Listener fuer Speichermodus-Radio-Buttons
    document.getElementById('save-mode-update').addEventListener('change', function() {
        if (this.checked && currentTemplateName) {
            document.getElementById('template-name-input').value = currentTemplateName;
        }
    });

    document.getElementById('save-mode-new').addEventListener('change', function() {
        if (this.checked && currentTemplateName) {
            document.getElementById('template-name-input').value = currentTemplateName + ' (Kopie)';
        }
    });

    // Event Listener fuer Trigger-Dropdown
    document.getElementById('template-trigger').addEventListener('change', toggleTriggerCustom);
});
</script>
{% endblock %}
