{% extends "base.html" %}

{% block title %}Wunschkalender - {{ periode.name }}{% endblock %}

{% block content %}
<input type="hidden" id="csrf-token" value="{{ csrf_token }}">
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>üìÖ {{ periode.name }}</h2>
            <p class="text-muted mb-0">
                {{ monat_name }} {{ periode.fuer_monat.year }}
                <span class="badge bg-success ms-2">{{ periode.get_status_display }}</span>
                {% if is_planer %}
                    <span class="badge bg-danger ms-2">Modus: Schichtplaner</span>
                {% endif %}
            </p>
        </div>
        <a href="{% url 'schichtplan:wunschperioden_liste' %}" class="btn btn-secondary">
            ‚Üê Zur√ºck
        </a>
    </div>

    <!-- Legende -->
    <div class="card mb-3">
        <div class="card-body py-2">
            <div class="row small align-items-center">
                <div class="col-auto"><span class="badge bg-danger">U</span> Urlaub</div>
                <div class="col-auto"><span class="badge" style="background-color: #e74c3c; color: white;">K</span> Krank</div>
                <div class="col-auto"><span class="badge bg-primary">2</span> Kein Tag, Nacht OK</div>
                <div class="col-auto"><span class="badge bg-warning text-dark">3</span> Keine Nacht, Tag OK</div>
                <div class="col-auto"><span class="badge bg-success">T</span> Tag bevorzugt</div>
                <div class="col-auto"><span class="badge" style="background-color: #6f42c1; color: white;">N</span> Nacht bevorzugt</div>
                <div class="col-auto"><span class="badge bg-dark">X</span> Gar nichts</div>
                <div class="col-auto"><span class="badge" style="background-color: #fd7e14; color: white;">+</span> Zusatzarbeit</div>
                <div class="col-auto border-start ms-2 ps-2"><span class="badge bg-info text-dark">Wochenende</span> hellblau</div>
                <div class="col-auto"><span style="background-color: #ffe4cc; padding: 2px 8px; border-radius: 4px;">Feiertag NRW</span> orange</div>
            </div>
        </div>
    </div>

    {% if periode.ist_offen %}
    <div class="card border shadow-sm mb-3 wunsch-panel-sticky">
        <div class="card-header bg-light py-2">
            <h6 class="mb-0">‚ûï Wunsch setzen</h6>
        </div>
        <div class="card-body py-2 d-flex align-items-center flex-wrap gap-3">
            <div class="d-flex align-items-center flex-wrap gap-2">
                <p class="text-muted small mb-0 me-2" style="max-width: 520px;">
                    <strong>Bedienung:</strong> Symbol greifen und in Ihre Spalte ziehen. Urlaub (U) und Krank (K) √∂ffnen den Von-Bis-Dialog. L√∂schen: in den M√ºlleimer ziehen.
                </p>
                <span class="text-muted small me-1">W√ºnsche:</span>
                <span class="badge wunsch-neu-draggable bg-danger" draggable="true" data-wunsch="urlaub" style="cursor: grab; font-size: 1rem; padding: 0.4em 0.6em;">U</span>
                <span class="badge wunsch-neu-draggable" draggable="true" data-wunsch="krank" style="background-color: #e74c3c; color: white; cursor: grab; font-size: 1rem; padding: 0.4em 0.6em;">K</span>
                <span class="badge wunsch-neu-draggable bg-primary" draggable="true" data-wunsch="kein_tag_aber_nacht" style="cursor: grab; font-size: 1rem; padding: 0.4em 0.6em;">2</span>
                <span class="badge wunsch-neu-draggable bg-warning text-dark" draggable="true" data-wunsch="keine_nacht_aber_tag" style="cursor: grab; font-size: 1rem; padding: 0.4em 0.6em;">3</span>
                <span class="badge wunsch-neu-draggable bg-success" draggable="true" data-wunsch="tag_bevorzugt" style="cursor: grab; font-size: 1rem; padding: 0.4em 0.6em;">T</span>
                <span class="badge wunsch-neu-draggable" draggable="true" data-wunsch="nacht_bevorzugt" style="background-color: #6f42c1; color: white; cursor: grab; font-size: 1rem; padding: 0.4em 0.6em;">N</span>
                <span class="badge wunsch-neu-draggable bg-dark" draggable="true" data-wunsch="gar_nichts" style="cursor: grab; font-size: 1rem; padding: 0.4em 0.6em;">X</span>
                <span class="badge wunsch-neu-draggable" draggable="true" data-wunsch="zusatzarbeit" style="background-color: #fd7e14; color: white; cursor: grab; font-size: 1rem; padding: 0.4em 0.6em;">+</span>
            </div>
            <div id="wunsch-trash" class="wunsch-trash border border-danger rounded px-3 py-2 bg-light text-danger d-flex align-items-center ms-auto" title="Wunsch hierher ziehen zum Loeschen" style="min-height: 38px; transition: background 0.2s, color 0.2s;">
                <span class="d-inline-block">üóëÔ∏è</span>
                <span class="small ms-1">Zum Loeschen hier ablegen</span>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Kalender -->
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered table-sm mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 100px;">Datum</th>
                            {% for ma in alle_mitarbeiter %}
                            <th class="text-center" style="min-width: 120px;">
                                {{ ma.vollname }}
                                {# Markierung f√ºr den eingeloggten User #}
                                {% if ma.pk == mitarbeiter.pk %}
                                <br><span class="badge bg-success" style="font-size: 0.7rem;">Ich</span>
                                {% endif %}
                            </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for tag in kalender_daten %}
                        <tr class="{% if tag.ist_wochenende %}table-info{% endif %}" {% if tag.feiertag_name %}style="background-color: #ffe4cc;"{% endif %}>
                            <td class="fw-bold align-middle">
                                {{ tag.datum|date:"d.m." }}
                                <br>
                                <small class="{% if tag.feiertag_name %}text-danger fw-bold{% elif tag.ist_wochenende %}text-primary{% else %}text-muted{% endif %}">
                                    {{ tag.wochentag }}
                                    {% if tag.feiertag_name %}
                                        <br><span title="Feiertag NRW">{{ tag.feiertag_name }}</span>
                                    {% endif %}
                                </small>
                            </td>
                            
                            {% for ma in alle_mitarbeiter %}
                            {# Eigene Spalte gelb markieren #}
                            <td class="text-center p-2 wunsch-cell {% if periode.ist_offen and ma.pk == mitarbeiter.pk %}wunsch-drop{% endif %}"
                                style="{% if ma.pk == mitarbeiter.pk %}background-color: #fff3cd; border-left: 2px solid #ffc107;{% endif %}"
                                {% if periode.ist_offen and ma.pk == mitarbeiter.pk %}data-ma-id="{{ ma.pk }}" data-datum="{{ tag.datum|date:'Y-m-d' }}"{% endif %}>
                                
                                {# 1. Vorhandene W√ºnsche anzeigen #}
                                {% for wunsch in tag.wuensche %}
                                    {% if wunsch.mitarbeiter.pk == ma.pk %}
                                        {% if wunsch.wunsch == 'urlaub' %}
                                            <span class="badge bg-danger {% if ma.pk == mitarbeiter.pk %}wunsch-draggable{% endif %}" {% if ma.pk == mitarbeiter.pk %}draggable="true" data-wunsch-id="{{ wunsch.pk }}"{% endif %} title="Urlaub">U</span>
                                        {% elif wunsch.wunsch == 'krank' %}
                                            <span class="badge {% if ma.pk == mitarbeiter.pk %}wunsch-draggable{% endif %}" {% if ma.pk == mitarbeiter.pk %}draggable="true" data-wunsch-id="{{ wunsch.pk }}"{% endif %} style="background-color: #e74c3c; color: white;" title="Krank">K</span>
                                        {% elif wunsch.wunsch == 'kein_tag_aber_nacht' %}
                                            <span class="badge bg-primary {% if ma.pk == mitarbeiter.pk %}wunsch-draggable{% endif %}" {% if ma.pk == mitarbeiter.pk %}draggable="true" data-wunsch-id="{{ wunsch.pk }}"{% endif %} title="Kein Tag, Nacht OK">2</span>
                                        {% elif wunsch.wunsch == 'keine_nacht_aber_tag' %}
                                            <span class="badge bg-warning text-dark {% if ma.pk == mitarbeiter.pk %}wunsch-draggable{% endif %}" {% if ma.pk == mitarbeiter.pk %}draggable="true" data-wunsch-id="{{ wunsch.pk }}"{% endif %} title="Keine Nacht, Tag OK">3</span>
                                        {% elif wunsch.wunsch == 'tag_bevorzugt' %}
                                            <span class="badge bg-success {% if ma.pk == mitarbeiter.pk %}wunsch-draggable{% endif %}" {% if ma.pk == mitarbeiter.pk %}draggable="true" data-wunsch-id="{{ wunsch.pk }}"{% endif %} title="Tag bevorzugt">T</span>
                                        {% elif wunsch.wunsch == 'nacht_bevorzugt' %}
                                            <span class="badge {% if ma.pk == mitarbeiter.pk %}wunsch-draggable{% endif %}" {% if ma.pk == mitarbeiter.pk %}draggable="true" data-wunsch-id="{{ wunsch.pk }}"{% endif %} style="background-color: #6f42c1; color: white;" title="Nacht bevorzugt">N</span>
                                        {% elif wunsch.wunsch == 'gar_nichts' %}
                                            <span class="badge bg-dark {% if ma.pk == mitarbeiter.pk %}wunsch-draggable{% endif %}" {% if ma.pk == mitarbeiter.pk %}draggable="true" data-wunsch-id="{{ wunsch.pk }}"{% endif %} title="Gar nichts">X</span>
                                        {% elif wunsch.wunsch == 'zusatzarbeit' %}
                                            <span class="badge {% if ma.pk == mitarbeiter.pk %}wunsch-draggable{% endif %}" {% if ma.pk == mitarbeiter.pk %}draggable="true" data-wunsch-id="{{ wunsch.pk }}"{% endif %} style="background-color: #fd7e14; color: white;" title="Zusatzarbeit">+</span>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                                
                                {# 2. Eingabe-Buttons (Die entscheidende √Ñnderung) #}
                                {% if periode.ist_offen %}
                                    {# Logik: Wenn eigene Spalte ODER User ist Schichtplaner/Admin #}
                                    {% if ma.pk == mitarbeiter.pk or user.is_staff or is_planer %}
                                        <div class="mt-1">
                                            <a href="{% url 'schichtplan:wunsch_eingeben' periode.pk %}?datum={{ tag.datum|date:'Y-m-d' }}&mitarbeiter_id={{ ma.pk }}" 
                                               class="btn btn-sm {% if ma.pk != mitarbeiter.pk %}btn-outline-warning{% else %}btn-outline-primary{% endif %}" 
                                               style="font-size: 0.7rem; padding: 0.05rem 0.2rem;"
                                               title="Wunsch f√ºr {{ ma.vollname }} bearbeiten">
                                                {# Stift f√ºr andere MA (Planer-Modus), Plus f√ºr sich selbst #}
                                                {% if ma.pk != mitarbeiter.pk %}‚úé{% else %}+{% endif %}
                                            </a>
                                        </div>
                                    {% endif %}
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Info -->
    <div class="alert alert-info mt-3">
        <strong>üí° Hinweise:</strong>
        <ul class="mb-0 small">
            <li>Klicken Sie auf <strong>+</strong> oder <strong>‚úé</strong>, um W√ºnsche zu verwalten.</li>
            {% if is_planer %}
                <li>Als <strong>Schichtplaner</strong> k√∂nnen Sie W√ºnsche f√ºr alle Mitarbeiter eintragen.</li>
            {% endif %}
        </ul>
    </div>

    <!-- Beteiligung / Bewertung: Wer hat wie viele W√ºnsche abgegeben? -->
    <div class="card mb-3">
        <div class="card-header bg-light py-2 d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#beteiligung-body" aria-expanded="true" style="cursor: pointer;">
            <h6 class="mb-0">üìä Beteiligung an der Wunschabfrage</h6>
            <small class="text-muted">Wer steht mit vielen W√ºnschen dahinter ‚Äì wer hat wenige Angaben gemacht?</small>
        </div>
        <div id="beteiligung-body" class="collapse show">
            <div class="card-body py-2 small">
                <p class="text-muted mb-2">Anzahl Tage mit abgegebenem Wunsch in dieser Periode (nur zur Transparenz, keine Bewertung der Person):</p>
                <div class="d-flex flex-wrap gap-2 align-items-center">
                    {% for item in beteiligung_liste %}
                    <span class="badge {% if item.einordnung == 'viele' %}bg-success{% elif item.einordnung == 'einige' %}bg-primary{% elif item.einordnung == 'wenige' %}bg-warning text-dark{% else %}bg-secondary{% endif %} py-2 px-2" title="{{ item.einordnung_label }}">
                        <strong>{{ item.ma.vollname }}</strong> {{ item.anzahl_tage }} Tage
                        <span class="d-none d-md-inline">‚Äì {{ item.einordnung_label }}</span>
                    </span>
                    {% endfor %}
                </div>
                <div class="mt-2 pt-2 border-top">
                    <span class="badge bg-success">Viele W√ºnsche</span> ¬∑
                    <span class="badge bg-primary">Mittlere Beteiligung</span> ¬∑
                    <span class="badge bg-warning text-dark">Wenige Angaben</span> ¬∑
                    <span class="badge bg-secondary">Keine W√ºnsche</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="urlaubModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Urlaub: Von-Bis</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schliessen"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2">
                    <label for="urlaub-von" class="form-label mb-1">Von</label>
                    <input type="date" class="form-control" id="urlaub-von">
                </div>
                <div class="mb-2">
                    <label for="urlaub-bis" class="form-label mb-1">Bis</label>
                    <input type="date" class="form-control" id="urlaub-bis">
                </div>
                <input type="hidden" id="urlaub-ma-id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-primary" id="urlaub-confirm">Speichern</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="krankModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Krank: Von-Bis</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schliessen"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2">
                    <label for="krank-von" class="form-label mb-1">Von</label>
                    <input type="date" class="form-control" id="krank-von">
                </div>
                <div class="mb-2">
                    <label for="krank-bis" class="form-label mb-1">Bis</label>
                    <input type="date" class="form-control" id="krank-bis">
                </div>
                <input type="hidden" id="krank-ma-id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-primary" id="krank-confirm">Speichern</button>
            </div>
        </div>
    </div>
</div>

<style>
.wunsch-neu-draggable,
.wunsch-draggable {
    cursor: grab;
}
.wunsch-neu-draggable:active,
.wunsch-draggable:active {
    cursor: grabbing;
}
.wunsch-drop {
    transition: background-color 0.15s;
}
.wunsch-panel-sticky {
    position: sticky;
    top: 0;
    z-index: 1020;
    background: #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}
</style>

<script>
(function() {
    if (!document.querySelector('.wunsch-neu-draggable')) return;

    var quickUrl = "{% url 'schichtplan:wunsch_schnell_setzen' periode.pk %}";
    var wunschLoeschenUrlTpl = "{% url 'schichtplan:wunsch_loeschen' 0 %}";
    var csrf = document.getElementById('csrf-token') && document.getElementById('csrf-token').value;

    function getCookie(name) {
        var match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
        return match ? match[2] : '';
    }
    if (!csrf) csrf = getCookie('csrftoken');

    function postForm(url, fields) {
        var body = new URLSearchParams(fields);
        return fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: body.toString()
        });
    }

    function submitWunsch(maId, datum, wunsch) {
        return postForm(quickUrl, {
            csrfmiddlewaretoken: csrf,
            mitarbeiter_id: maId,
            datum: datum,
            wunsch: wunsch
        });
    }

    function submitUrlaubRange(maId, von, bis) {
        return postForm(quickUrl, {
            csrfmiddlewaretoken: csrf,
            mitarbeiter_id: maId,
            wunsch: 'urlaub',
            von_datum: von,
            bis_datum: bis
        });
    }

    function submitKrankRange(maId, von, bis) {
        return postForm(quickUrl, {
            csrfmiddlewaretoken: csrf,
            mitarbeiter_id: maId,
            wunsch: 'krank',
            von_datum: von,
            bis_datum: bis
        });
    }

    function submitWunschLoeschen(wunschId) {
        var form = document.createElement('form');
        form.method = 'POST';
        form.action = wunschLoeschenUrlTpl.replace('0', wunschId);
        var input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'csrfmiddlewaretoken';
        input.value = csrf;
        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    }

    var urlaubModalEl = document.getElementById('urlaubModal');
    var urlaubVonEl = document.getElementById('urlaub-von');
    var urlaubBisEl = document.getElementById('urlaub-bis');
    var urlaubMaIdEl = document.getElementById('urlaub-ma-id');
    var urlaubConfirmBtn = document.getElementById('urlaub-confirm');
    var urlaubModal = urlaubModalEl && window.bootstrap ? new bootstrap.Modal(urlaubModalEl) : null;

    var krankModalEl = document.getElementById('krankModal');
    var krankVonEl = document.getElementById('krank-von');
    var krankBisEl = document.getElementById('krank-bis');
    var krankMaIdEl = document.getElementById('krank-ma-id');
    var krankConfirmBtn = document.getElementById('krank-confirm');
    var krankModal = krankModalEl && window.bootstrap ? new bootstrap.Modal(krankModalEl) : null;

    document.querySelectorAll('.wunsch-neu-draggable').forEach(function(el) {
        el.addEventListener('dragstart', function(e) {
            e.dataTransfer.setData('wunsch_neu_typ', el.getAttribute('data-wunsch'));
            e.dataTransfer.setData('wunsch_id', '');
            e.dataTransfer.effectAllowed = 'copy';
            el.classList.add('opacity-50');
        });
        el.addEventListener('dragend', function() {
            el.classList.remove('opacity-50');
        });
    });

    document.querySelectorAll('.wunsch-draggable').forEach(function(el) {
        el.addEventListener('dragstart', function(e) {
            e.dataTransfer.setData('wunsch_id', el.getAttribute('data-wunsch-id'));
            e.dataTransfer.setData('wunsch_neu_typ', '');
            e.dataTransfer.effectAllowed = 'move';
            el.classList.add('opacity-50');
        });
        el.addEventListener('dragend', function() {
            el.classList.remove('opacity-50');
        });
    });

    document.querySelectorAll('.wunsch-drop').forEach(function(td) {
        td.addEventListener('dragover', function(e) {
            var kuerzel = e.dataTransfer.getData('wunsch_neu_typ');
            if (!kuerzel) return;
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
            td.classList.add('table-warning');
        });
        td.addEventListener('dragleave', function() {
            td.classList.remove('table-warning');
        });
        td.addEventListener('drop', function(e) {
            e.preventDefault();
            td.classList.remove('table-warning');
            var wunschTyp = e.dataTransfer.getData('wunsch_neu_typ');
            var maId = td.getAttribute('data-ma-id');
            var datum = td.getAttribute('data-datum');
            if (!wunschTyp || !maId || !datum) return;
            if (wunschTyp === 'urlaub') {
                pendingUrlaub = { maId: maId, datum: datum };
                if (urlaubVonEl) urlaubVonEl.value = datum;
                if (urlaubBisEl) urlaubBisEl.value = datum;
                if (urlaubMaIdEl) urlaubMaIdEl.value = maId;
                if (urlaubModal) {
                    urlaubModal.show();
                } else {
                    submitWunsch(maId, datum, wunschTyp).then(function(resp) {
                        if (!resp.ok) {
                            return resp.json().then(function(data) {
                                throw new Error(data && data.error ? data.error : 'Speichern fehlgeschlagen.');
                            });
                        }
                        window.location.reload();
                    }).catch(function(err) {
                        alert(err.message || 'Speichern fehlgeschlagen.');
                    });
                }
                return;
            }
            if (wunschTyp === 'krank') {
                pendingKrank = { maId: maId, datum: datum };
                if (krankVonEl) krankVonEl.value = datum;
                if (krankBisEl) krankBisEl.value = datum;
                if (krankMaIdEl) krankMaIdEl.value = maId;
                if (krankModal) {
                    krankModal.show();
                } else {
                    submitWunsch(maId, datum, wunschTyp).then(function(resp) {
                        if (!resp.ok) {
                            return resp.json().then(function(data) {
                                throw new Error(data && data.error ? data.error : 'Speichern fehlgeschlagen.');
                            });
                        }
                        window.location.reload();
                    }).catch(function(err) {
                        alert(err.message || 'Speichern fehlgeschlagen.');
                    });
                }
                return;
            }
            submitWunsch(maId, datum, wunschTyp).then(function(resp) {
                if (!resp.ok) {
                    return resp.json().then(function(data) {
                        throw new Error(data && data.error ? data.error : 'Speichern fehlgeschlagen.');
                    });
                }
                window.location.reload();
            }).catch(function(err) {
                alert(err.message || 'Speichern fehlgeschlagen.');
            });
        });
    });

    if (urlaubConfirmBtn) {
        urlaubConfirmBtn.addEventListener('click', function() {
            var maId = urlaubMaIdEl ? urlaubMaIdEl.value : '';
            var von = urlaubVonEl ? urlaubVonEl.value : '';
            var bis = urlaubBisEl ? urlaubBisEl.value : '';
            if (!maId || !von || !bis) {
                alert('Bitte Von und Bis auswaehlen.');
                return;
            }
            submitUrlaubRange(maId, von, bis).then(function(resp) {
                if (!resp.ok) {
                    return resp.json().then(function(data) {
                        throw new Error(data && data.error ? data.error : 'Speichern fehlgeschlagen.');
                    });
                }
                window.location.reload();
            }).catch(function(err) {
                alert(err.message || 'Speichern fehlgeschlagen.');
            });
        });
    }

    if (krankConfirmBtn) {
        krankConfirmBtn.addEventListener('click', function() {
            var maId = krankMaIdEl ? krankMaIdEl.value : '';
            var von = krankVonEl ? krankVonEl.value : '';
            var bis = krankBisEl ? krankBisEl.value : '';
            if (!maId || !von || !bis) {
                alert('Bitte Von und Bis auswaehlen.');
                return;
            }
            submitKrankRange(maId, von, bis).then(function(resp) {
                if (!resp.ok) {
                    return resp.json().then(function(data) {
                        throw new Error(data && data.error ? data.error : 'Speichern fehlgeschlagen.');
                    });
                }
                window.location.reload();
            }).catch(function(err) {
                alert(err.message || 'Speichern fehlgeschlagen.');
            });
        });
    }

    var trash = document.getElementById('wunsch-trash');
    if (trash) {
        trash.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            trash.classList.add('bg-danger', 'text-white', 'border-2');
        });
        trash.addEventListener('dragleave', function() {
            trash.classList.remove('bg-danger', 'text-white', 'border-2');
        });
        trash.addEventListener('drop', function(e) {
            e.preventDefault();
            trash.classList.remove('bg-danger', 'text-white', 'border-2');
            var wunschId = e.dataTransfer.getData('wunsch_id');
            if (wunschId && confirm('Wunsch wirklich loeschen?')) {
                submitWunschLoeschen(wunschId);
            }
        });
    }
})();
</script>
{% endblock %}
