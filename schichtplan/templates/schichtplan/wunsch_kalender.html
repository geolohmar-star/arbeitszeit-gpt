{% extends "base.html" %}

{% block title %}Wunschkalender - {{ periode.name }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>üìÖ {{ periode.name }}</h2>
            <p class="text-muted mb-0">
                {{ monat_name }} {{ periode.fuer_monat.year }}
                <span class="badge bg-success ms-2">{{ periode.get_status_display }}</span>
                {% if is_planer %}
                    <span class="badge bg-danger ms-2">Modus: Schichtplaner</span>
                {% endif %}
            </p>
        </div>
        <a href="{% url 'schichtplan:wunschperioden_liste' %}" class="btn btn-secondary">
            ‚Üê Zur√ºck
        </a>
    </div>

    <!-- Legende -->
    <div class="card mb-3">
        <div class="card-body py-2">
            <div class="row small align-items-center">
                <div class="col-auto"><span class="badge bg-danger">U</span> Urlaub</div>
                <div class="col-auto"><span class="badge bg-primary">2</span> Kein Tag, Nacht OK</div>
                <div class="col-auto"><span class="badge bg-warning text-dark">3</span> Keine Nacht, Tag OK</div>
                <div class="col-auto"><span class="badge bg-success">T</span> Tag bevorzugt</div>
                <div class="col-auto"><span class="badge" style="background-color: #6f42c1; color: white;">N</span> Nacht bevorzugt</div>
                <div class="col-auto"><span class="badge bg-dark">X</span> Gar nichts</div>
                <div class="col-auto"><span class="badge" style="background-color: #fd7e14; color: white;">+</span> Zusatzarbeit</div>
                <div class="col-auto border-start ms-2 ps-2"><span class="badge bg-info text-dark">Wochenende</span> hellblau</div>
                <div class="col-auto"><span style="background-color: #ffe4cc; padding: 2px 8px; border-radius: 4px;">Feiertag NRW</span> orange</div>
            </div>
        </div>
    </div>

    <!-- Beteiligung / Bewertung: Wer hat wie viele W√ºnsche abgegeben? -->
    <div class="card mb-3">
        <div class="card-header bg-light py-2 d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#beteiligung-body" aria-expanded="true" style="cursor: pointer;">
            <h6 class="mb-0">üìä Beteiligung an der Wunschabfrage</h6>
            <small class="text-muted">Wer steht mit vielen W√ºnschen dahinter ‚Äì wer hat wenige Angaben gemacht?</small>
        </div>
        <div id="beteiligung-body" class="collapse show">
            <div class="card-body py-2 small">
                <p class="text-muted mb-2">Anzahl Tage mit abgegebenem Wunsch in dieser Periode (nur zur Transparenz, keine Bewertung der Person):</p>
                <div class="d-flex flex-wrap gap-2 align-items-center">
                    {% for item in beteiligung_liste %}
                    <span class="badge {% if item.einordnung == 'viele' %}bg-success{% elif item.einordnung == 'einige' %}bg-primary{% elif item.einordnung == 'wenige' %}bg-warning text-dark{% else %}bg-secondary{% endif %} py-2 px-2" title="{{ item.einordnung_label }}">
                        <strong>{{ item.ma.schichtplan_kennung }}</strong> {{ item.anzahl_tage }} Tage
                        <span class="d-none d-md-inline">‚Äì {{ item.einordnung_label }}</span>
                    </span>
                    {% endfor %}
                </div>
                <div class="mt-2 pt-2 border-top">
                    <span class="badge bg-success">Viele W√ºnsche</span> ¬∑
                    <span class="badge bg-primary">Mittlere Beteiligung</span> ¬∑
                    <span class="badge bg-warning text-dark">Wenige Angaben</span> ¬∑
                    <span class="badge bg-secondary">Keine W√ºnsche</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Kalender -->
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered table-sm mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 100px;">Datum</th>
                            {% for ma in alle_mitarbeiter %}
                            <th class="text-center" style="min-width: 60px;">
                                {{ ma.schichtplan_kennung }}
                                {# Markierung f√ºr den eingeloggten User #}
                                {% if ma.pk == mitarbeiter.pk %}
                                <br><span class="badge bg-success" style="font-size: 0.7rem;">Ich</span>
                                {% endif %}
                            </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for tag in kalender_daten %}
                        <tr class="{% if tag.ist_wochenende %}table-info{% endif %}" {% if tag.feiertag_name %}style="background-color: #ffe4cc;"{% endif %}>
                            <td class="fw-bold align-middle">
                                {{ tag.datum|date:"d.m." }}
                                <br>
                                <small class="{% if tag.feiertag_name %}text-danger fw-bold{% elif tag.ist_wochenende %}text-primary{% else %}text-muted{% endif %}">
                                    {{ tag.wochentag }}
                                    {% if tag.feiertag_name %}
                                        <br><span title="Feiertag NRW">{{ tag.feiertag_name }}</span>
                                    {% endif %}
                                </small>
                            </td>
                            
                            {% for ma in alle_mitarbeiter %}
                            {# Eigene Spalte gelb markieren #}
                            <td class="text-center p-2" 
                                style="{% if ma.pk == mitarbeiter.pk %}background-color: #fff3cd; border-left: 2px solid #ffc107;{% endif %}">
                                
                                {# 1. Vorhandene W√ºnsche anzeigen #}
                                {% for wunsch in tag.wuensche %}
                                    {% if wunsch.mitarbeiter.pk == ma.pk %}
                                        {% if wunsch.wunsch == 'urlaub' %}
                                            <span class="badge bg-danger" title="Urlaub">U</span>
                                        {% elif wunsch.wunsch == 'kein_tag_aber_nacht' %}
                                            <span class="badge bg-primary" title="Kein Tag, Nacht OK">2</span>
                                        {% elif wunsch.wunsch == 'keine_nacht_aber_tag' %}
                                            <span class="badge bg-warning text-dark" title="Keine Nacht, Tag OK">3</span>
                                        {% elif wunsch.wunsch == 'tag_bevorzugt' %}
                                            <span class="badge bg-success" title="Tag bevorzugt">T</span>
                                        {% elif wunsch.wunsch == 'nacht_bevorzugt' %}
                                            <span class="badge" style="background-color: #6f42c1; color: white;" title="Nacht bevorzugt">N</span>
                                        {% elif wunsch.wunsch == 'gar_nichts' %}
                                            <span class="badge bg-dark" title="Gar nichts">X</span>
                                        {% elif wunsch.wunsch == 'zusatzarbeit' %}
                                            <span class="badge" style="background-color: #fd7e14; color: white;" title="Zusatzarbeit">+</span>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                                
                                {# 2. Eingabe-Buttons (Die entscheidende √Ñnderung) #}
                                {% if periode.ist_offen %}
                                    {# Logik: Wenn eigene Spalte ODER User ist Schichtplaner/Admin #}
                                    {% if ma.pk == mitarbeiter.pk or user.is_staff or is_planer %}
                                        <div class="mt-1">
                                            <a href="{% url 'schichtplan:wunsch_eingeben' periode.pk %}?datum={{ tag.datum|date:'Y-m-d' }}&mitarbeiter_id={{ ma.pk }}" 
                                               class="btn btn-sm {% if ma.pk != mitarbeiter.pk %}btn-outline-warning{% else %}btn-outline-primary{% endif %}" 
                                               style="font-size: 0.7rem; padding: 0.05rem 0.2rem;"
                                               title="Wunsch f√ºr {{ ma.schichtplan_kennung }} bearbeiten">
                                                {# Stift f√ºr andere MA (Planer-Modus), Plus f√ºr sich selbst #}
                                                {% if ma.pk != mitarbeiter.pk %}‚úé{% else %}+{% endif %}
                                            </a>
                                        </div>
                                    {% endif %}
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Info -->
    <div class="alert alert-info mt-3">
        <strong>üí° Hinweise:</strong>
        <ul class="mb-0 small">
            <li>Klicken Sie auf <strong>+</strong> oder <strong>‚úé</strong>, um W√ºnsche zu verwalten.</li>
            {% if is_planer %}
                <li>Als <strong>Schichtplaner</strong> k√∂nnen Sie W√ºnsche f√ºr alle Mitarbeiter eintragen.</li>
            {% endif %}
        </ul>
    </div>
</div>
{% endblock %}