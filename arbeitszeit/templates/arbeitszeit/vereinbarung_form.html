{% load static %}
<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Neue Arbeitszeitvereinbarung</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Fraunces:wght@600&display=swap" rel="stylesheet">
<style>

/* Sections initial versteckt - wird durch JavaScript gesteuert */
#individuell-section,
#regelmaessig-section {
    display: none;
}
body { font-family: 'DM Sans', sans-serif; background: #faf9f6; color: #1f2421; min-height: 100vh;}
.header {background: linear-gradient(135deg,#1a4d2e 0%,#2d6a4f 100%);color:white;padding:1.5rem 2rem;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
.header-content {max-width:1000px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;}
.logo {font-family:'Fraunces',serif;font-size:1.5rem;font-weight:600;}
.nav-link {color:white;text-decoration:none;font-weight:500;transition:opacity 0.2s;}
.nav-link:hover {opacity:0.8;}
.container {max-width:900px;margin:0 auto;padding:2rem;}
.page-title {font-family:'Fraunces',serif;font-size:2.5rem;color:#1a4d2e;margin-bottom:0.5rem;}
.page-subtitle {color:#52796f;margin-bottom:2rem;font-size:1.1rem;}
.form-card {background:white;border-radius:12px;padding:2rem;box-shadow:0 2px 12px rgba(0,0,0,0.08);margin-bottom:1.5rem;}
.section-title {font-size:1.25rem;font-weight:600;color:#1a4d2e;margin-bottom:1.5rem;padding-bottom:0.75rem;border-bottom:2px solid #d6e4df;}
.form-group {margin-bottom:1.5rem;}
.form-label {display:block;font-weight:600;margin-bottom:0.75rem;color:#1f2421;}
.required {color:#dc3545;}
.help-text {font-size:0.875rem;color:#52796f;margin-top:0.25rem;}
.radio-group,.checkbox-group {display:grid;gap:1rem;}
.radio-option,.checkbox-option {display:flex;align-items:flex-start;padding:1rem;border:2px solid #d6e4df;border-radius:8px;cursor:pointer;transition:all 0.2s;}
.radio-option:hover,.checkbox-option:hover {border-color:#1a4d2e;background:rgba(26,77,46,0.02);}
.radio-option input[type="radio"],.checkbox-option input[type="checkbox"] {margin-right:1rem;width:20px;height:20px;accent-color:#1a4d2e;cursor:pointer;}
.option-content {flex:1;}
.option-title {font-weight:600;margin-bottom:0.25rem;}
.input-field {width:100%;padding:0.75rem;border:2px solid #d6e4df;border-radius:8px;font-size:1rem;font-family:'DM Sans',sans-serif;transition:border-color 0.2s;}
.input-field:focus {outline:none;border-color:#1a4d2e;}
.form-actions {display:flex;gap:1rem;justify-content:flex-end;margin-top:2rem;padding-top:2rem;border-top:2px solid #d6e4df;}
.btn {padding:0.875rem 2rem;border:none;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;transition:all 0.2s;text-decoration:none;display:inline-block;}
.btn-primary {background:#1a4d2e;color:white;}
.btn-primary:hover {background:#2d6a4f;transform:translateY(-2px);box-shadow:0 4px 12px rgba(26,77,46,0.3);}
.btn-secondary {background:#d6e4df;color:#1f2421;}
.btn-secondary:hover {background:#c0d4cc;}
.time-input {font-family:'Courier New',monospace;font-size:1.1rem;text-align:center;letter-spacing:2px;}
.time-input:focus {border-color:#1a4d2e;box-shadow:0 0 5px rgba(26,77,46,0.3);}
.info-box {background:#d1ecf1;color:#0c5460;padding:1rem;border-radius:8px;margin-bottom:1.5rem;border-left:4px solid #0c5460;}
.info-box-ersteinrichtung {background:#fff3cd;color:#856404;padding:1rem;border-radius:8px;margin-bottom:1.5rem;border-left:4px solid #856404;}
.readonly-summary {background:#f8f9fa;border:2px solid #d6e4df;border-radius:8px;padding:1.5rem;margin-top:1rem;}
.readonly-summary dt {font-weight:600;color:#1a4d2e;margin-bottom:0.25rem;}
.readonly-summary dd {margin-left:0;margin-bottom:1rem;color:#1f2421;}
.readonly-summary dd:last-child {margin-bottom:0;}
</style>
</head>
<body>
<!-- Header -->
<div class="header">
    <div class="header-content">
        <div class="logo">Arbeitszeitverwaltung</div>
        <a href="{% url 'arbeitszeit:dashboard' %}" class="nav-link">&larr; Zurueck zum Dashboard</a>
    </div>
</div>

<div class="container">
<h1 class="page-title">Neue Arbeitszeitvereinbarung</h1>
<p class="page-subtitle">
  {% if hat_vereinbarung %}
    Beantragen Sie eine Aenderung Ihrer Arbeitszeit
  {% else %}
    Erfassen Sie Ihren aktuellen Arbeitsvertrag
  {% endif %}
</p>

{% if hat_vereinbarung %}
<div class="info-box">
    <strong>Hinweis:</strong> Diese Version wird ab dem angegebenen Datum die vorherige ersetzen.
    Bestehende Vereinbarungen bleiben als Historie erhalten.
</div>
{% else %}
<div class="info-box-ersteinrichtung">
    <strong>Ersteinrichtung:</strong> Bitte erfassen Sie die Daten Ihres gueltigen Arbeitsvertrags.
    Dies ist notwendig, damit Soll-Stunden und Zeiterfassung korrekt berechnet werden.
</div>
{% endif %}

<form method="post" id="vereinbarung-form">
{% csrf_token %}

<!-- 1. Antragsart -->
<div class="form-card">
<h2 class="section-title">1. Art des Antrags <span class="required">*</span></h2>
<div class="radio-group">

  {% if not hat_vereinbarung %}
  <!-- Ersteinrichtung: nur fuer Nutzer ohne bestehende Vereinbarung -->
  <label class="radio-option">
    <input type="radio" name="antragsart" value="ersteinrichtung" required checked>
    <div class="option-content">
      <div class="option-title">Ersteinrichtung</div>
      <div class="help-text">Erstmalige Erfassung Ihres Arbeitsvertrags</div>
    </div>
  </label>
  {% else %}
  <!-- Aenderungen: nur fuer Nutzer mit bestehender Vereinbarung -->
  <label class="radio-option">
    <input type="radio" name="antragsart" value="weiterbewilligung" required>
    <div class="option-content">
      <div class="option-title">Weiterbewilligung</div>
      <div class="help-text">Verlaengerung der bestehenden Vereinbarung</div>
    </div>
  </label>
  <label class="radio-option">
    <input type="radio" name="antragsart" value="verringerung">
    <div class="option-content">
      <div class="option-title">Verringerung</div>
      <div class="help-text">Reduzierung der Arbeitszeit</div>
    </div>
  </label>
  <label class="radio-option">
    <input type="radio" name="antragsart" value="erhoehung">
    <div class="option-content">
      <div class="option-title">Erhoehung</div>
      <div class="help-text">Aufstockung der Arbeitszeit</div>
    </div>
  </label>
  <label class="radio-option">
    <input type="radio" name="antragsart" value="beendigung">
    <div class="option-content">
      <div class="option-title">Beendigung</div>
      <div class="help-text">Beendigung der aktuellen Vereinbarung</div>
    </div>
  </label>
  {% endif %}

</div>
</div>

{% if hat_vereinbarung and aktuelle_vereinbarung %}
<!-- Weiterbewilligung: Read-Only Zusammenfassung der aktuellen Vereinbarung -->
<div class="form-card" id="weiterbewilligung-card" style="display:none;">
<h2 class="section-title">2. Aktuelle Vereinbarung (wird uebernommen)</h2>
<div class="readonly-summary">
  <dl>
    <dt>Arbeitszeit-Typ</dt>
    <dd>{{ aktuelle_vereinbarung.get_arbeitszeit_typ_display }}</dd>

    <dt>Wochenstunden</dt>
    <dd>{{ aktuelle_vereinbarung.wochenstunden }} Std.</dd>

    <dt>Telearbeit</dt>
    <dd>{% if aktuelle_vereinbarung.telearbeit %}Ja{% else %}Nein{% endif %}</dd>

    {% if aktuelle_vereinbarung.arbeitszeit_typ == "individuell" and aktuelle_tageszeiten %}
    <dt>Tagesverteilung</dt>
    <dd>
      <table style="border-collapse:collapse;width:100%;max-width:400px;">
        {% for eintrag in aktuelle_tageszeiten %}
        <tr>
          <td style="padding:0.25rem 1rem 0.25rem 0;font-weight:500;">{{ eintrag.tag }}</td>
          <td style="padding:0.25rem 0;">{{ eintrag.zeit }}</td>
        </tr>
        {% endfor %}
      </table>
    </dd>
    {% endif %}

    {% if aktuelle_vereinbarung.gueltig_ab %}
    <dt>Gueltig ab</dt>
    <dd>{{ aktuelle_vereinbarung.gueltig_ab|date:"d.m.Y" }}</dd>
    {% endif %}
  </dl>
</div>
</div>
{% endif %}

<!-- 2. Arbeitszeit-Typ (nicht fuer Beendigung und nicht fuer Weiterbewilligung) -->
<div class="form-card" id="arbeitszeit-card">
<h2 class="section-title">2. Art der Arbeitszeitverteilung <span class="required">*</span></h2>
<div class="radio-group">
  <label class="radio-option">
    <input type="radio" name="arbeitszeit_typ" value="regelmaessig" id="radio-regelmaessig">
    <div class="option-content">
      <div class="option-title">Regelmaessig</div>
      <div class="help-text">Gleiche Stundenzahl jeden Tag</div>
    </div>
  </label>
  <label class="radio-option">
    <input type="radio" name="arbeitszeit_typ" value="individuell" id="radio-individuell">
    <div class="option-content">
      <div class="option-title">Individuell</div>
      <div class="help-text">Unterschiedliche Stunden pro Tag</div>
    </div>
  </label>
</div>

<!-- Regelmaessig -->
<div id="regelmaessig-section" >
<div class="form-group">
<label for="wochenstunden" class="form-label">Wochenstunden <span class="required">*</span></label>
<input type="number" id="wochenstunden" name="wochenstunden" class="input-field" min="1" max="48" step="0.5" placeholder="z.B. 40">
<div class="help-text">Anzahl der woechentlichen Arbeitsstunden</div>
</div>
</div>


<!-- Individuell -->
<div id="individuell-section" >
    <p class="help-text">Geben Sie fuer jeden Tag die gewuenschte Arbeitszeit ein:</p>

    <div id="weeks-container">
      <div class="week" data-week="1">
        <div class="week-header">
          <h3 class="week-title">Woche 1</h3>
          <button type="button" class="remove-week">&times;</button>
        </div>

        {% for tag in tage_list %}
        <div class="day-input">
            <label class="day-label">{{ tag|capfirst }}</label>
            <input type="time" name="neuantrag_{{ tag }}_1" class="input-field time-input">
        </div>
        {% endfor %}
      </div>
    </div>

    <button type="button" id="add-week" class="btn btn-secondary" style="margin-top: 1rem;">+ Woche hinzufuegen</button>
</div>
</div>

<!-- 3. Gueltigkeit / Beendigung -->
<div class="form-card">
<h2 class="section-title" id="gueltigkeits-title">3. Gueltigkeit</h2>
<div class="form-group" id="gueltig-ab-group">
<label for="datum_input" class="form-label" id="datum-label">Gueltig ab <span class="required">*</span></label>
<input type="date" id="datum_input" name="gueltig_ab" class="input-field" required>
<div class="help-text" id="datum-help">Datum, ab dem die Vereinbarung gueltig ist</div>
</div>
<div class="form-group" id="gueltig-bis-group">
<label for="gueltig_bis" class="form-label">Gueltig bis (optional)</label>
<input type="date" id="gueltig_bis" name="gueltig_bis" class="input-field">
<div class="help-text">Leer lassen fuer unbefristet</div>
</div>
</div>

<!-- 4. Telearbeit (nicht fuer Weiterbewilligung) -->
<div class="form-card" id="telearbeit-card">
<h2 class="section-title">4. Arbeitsort</h2>
<div class="checkbox-group">
<label class="checkbox-option">
<input type="checkbox" name="telearbeit" id="telearbeit">
<div class="option-content">
<div class="option-title">In Telearbeit</div>
<div class="help-text">Teilweise von zu Hause arbeiten</div>
</div>
</label>
</div>
</div>

<!-- Buttons -->
<div class="form-actions">
<a href="{% url 'arbeitszeit:dashboard' %}" class="btn btn-secondary">Abbrechen</a>
<button type="submit" class="btn btn-primary">Vereinbarung beantragen</button>
</div>
</form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

  // --- 1. Antragsart Toggle ---
  var antragsartRadios = document.querySelectorAll('input[name="antragsart"]');
  var arbeitszeitCard = document.getElementById('arbeitszeit-card');
  var weiterbewilligungCard = document.getElementById('weiterbewilligung-card');
  var gueltigkeitTitle = document.getElementById('gueltigkeits-title');
  var datumLabel = document.getElementById('datum-label');
  var datumHelp = document.getElementById('datum-help');
  var datumInput = document.getElementById('datum_input');
  var gueltigAbGroup = document.getElementById('gueltig-ab-group');
  var gueltigBisGroup = document.getElementById('gueltig-bis-group');
  var telearbeitCard = document.getElementById('telearbeit-card');

  function handleAntragsartChange(value) {
    if (value === 'beendigung') {
      // Beendigung: Arbeitszeit und Telearbeit ausblenden
      if (arbeitszeitCard) arbeitszeitCard.style.display = 'none';
      if (weiterbewilligungCard) weiterbewilligungCard.style.display = 'none';
      if (telearbeitCard) telearbeitCard.style.display = 'none';
      if (gueltigkeitTitle) gueltigkeitTitle.textContent = '2. Beendigungsdatum';
      if (datumLabel) datumLabel.innerHTML = 'Beendigung zum <span class="required">*</span>';
      if (datumHelp) datumHelp.textContent = 'Datum, zu dem die Vereinbarung beendet werden soll';
      if (gueltigAbGroup) gueltigAbGroup.style.display = 'block';
      if (gueltigBisGroup) gueltigBisGroup.style.display = 'none';
      if (datumInput) {
        datumInput.name = 'gueltig_ab';
        datumInput.required = true;
      }
    } else if (value === 'weiterbewilligung') {
      // Weiterbewilligung: Read-only Zusammenfassung anzeigen
      if (arbeitszeitCard) arbeitszeitCard.style.display = 'none';
      if (weiterbewilligungCard) weiterbewilligungCard.style.display = 'block';
      if (telearbeitCard) telearbeitCard.style.display = 'none';
      if (gueltigkeitTitle) gueltigkeitTitle.textContent = '3. Gueltigkeit';
      if (datumLabel) datumLabel.innerHTML = 'Gueltig ab <span class="required">*</span>';
      if (datumHelp) datumHelp.textContent = 'Datum, ab dem die Vereinbarung gueltig ist';
      // gueltig_ab ausblenden (wird serverseitig gesetzt)
      if (gueltigAbGroup) gueltigAbGroup.style.display = 'none';
      if (gueltigBisGroup) gueltigBisGroup.style.display = 'block';
      // gueltig_ab nicht required, da serverseitig
      if (datumInput) {
        datumInput.name = 'gueltig_ab';
        datumInput.required = false;
      }
    } else {
      // Ersteinrichtung, Verringerung, Erhoehung: volle Eingabe
      if (arbeitszeitCard) arbeitszeitCard.style.display = 'block';
      if (weiterbewilligungCard) weiterbewilligungCard.style.display = 'none';
      if (telearbeitCard) telearbeitCard.style.display = 'block';
      if (gueltigkeitTitle) gueltigkeitTitle.textContent = '3. Gueltigkeit';
      if (datumLabel) datumLabel.innerHTML = 'Gueltig ab <span class="required">*</span>';
      if (datumHelp) datumHelp.textContent = 'Datum, ab dem die Vereinbarung gueltig ist';
      if (gueltigAbGroup) gueltigAbGroup.style.display = 'block';
      if (gueltigBisGroup) gueltigBisGroup.style.display = 'block';
      if (datumInput) {
        datumInput.name = 'gueltig_ab';
        datumInput.required = true;
      }
    }
  }

  if (antragsartRadios.length > 0) {
    antragsartRadios.forEach(function(radio) {
      radio.addEventListener('change', function() {
        handleAntragsartChange(this.value);
      });
    });
    // Initial: Falls bereits ein Radio gecheckt ist (z.B. Ersteinrichtung)
    var checkedRadio = document.querySelector('input[name="antragsart"]:checked');
    if (checkedRadio) {
      handleAntragsartChange(checkedRadio.value);
    }
  }

  // --- 2. Arbeitszeit-Typ Toggle (Regelmaessig vs. Individuell) ---
  var regelRadio = document.getElementById('radio-regelmaessig');
  var indivRadio = document.getElementById('radio-individuell');
  var regelSection = document.getElementById('regelmaessig-section');
  var indivSection = document.getElementById('individuell-section');

  function toggleArbeitszeit() {
    if (regelRadio && regelRadio.checked) {
      if (regelSection) {
        regelSection.style.display = 'block';
        regelSection.style.visibility = 'visible';
      }
      if (indivSection) {
        indivSection.style.display = 'none';
        indivSection.style.visibility = 'hidden';
      }
    } else if (indivRadio && indivRadio.checked) {
      if (indivSection) {
        indivSection.style.display = 'block';
        indivSection.style.visibility = 'visible';
      }
      if (regelSection) {
        regelSection.style.display = 'none';
        regelSection.style.visibility = 'hidden';
      }
    }
  }

  if (regelRadio && indivRadio) {
    regelRadio.addEventListener('change', toggleArbeitszeit);
    indivRadio.addEventListener('change', toggleArbeitszeit);
    toggleArbeitszeit();
  }

  // --- 3. Wochen hinzufuegen Logik ---
  var addWeekBtn = document.getElementById('add-week');
  var weeksContainer = document.getElementById('weeks-container');
  var weekCount = document.querySelectorAll('.week').length;

  // Erste Woche: Loeschen-Button ausblenden
  var firstRemoveBtn = document.querySelector('.week .remove-week');
  if (firstRemoveBtn) {
    firstRemoveBtn.style.display = 'none';
  }

  if (addWeekBtn && weeksContainer) {
    addWeekBtn.addEventListener('click', function() {
      weekCount++;
      var originalWeek = weeksContainer.querySelector('.week');
      var newWeek = originalWeek.cloneNode(true);
      newWeek.dataset.week = weekCount;

      var titleElement = newWeek.querySelector('.week-title');
      if (titleElement) {
        titleElement.textContent = 'Woche ' + weekCount;
      }

      newWeek.querySelectorAll('input').forEach(function(input) {
        input.value = '';
        var parts = input.name.split('_');
        if (parts.length >= 3) {
          input.name = parts[0] + '_' + parts[1] + '_' + weekCount;
        }
      });

      var removeBtn = newWeek.querySelector('.remove-week');
      if (removeBtn) {
        removeBtn.style.display = 'inline-block';
        removeBtn.onclick = function() {
          newWeek.remove();
        };
      }

      weeksContainer.appendChild(newWeek);
    });
  }
});
</script>
</body>
</html>
