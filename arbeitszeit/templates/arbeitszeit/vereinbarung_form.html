{% load static %}
<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Neue Arbeitszeitvereinbarung</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Fraunces:wght@600&display=swap" rel="stylesheet">
<style>

/* Sections initial versteckt - wird durch JavaScript gesteuert */
#individuell-section,
#regelmaessig-section {
    display: none;
}
body { font-family: 'DM Sans', sans-serif; background: #faf9f6; color: #1f2421; min-height: 100vh;}
.header {background: linear-gradient(135deg,#1a4d2e 0%,#2d6a4f 100%);color:white;padding:1.5rem 2rem;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
.header-content {max-width:1000px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;}
.logo {font-family:'Fraunces',serif;font-size:1.5rem;font-weight:600;}
.nav-link {color:white;text-decoration:none;font-weight:500;transition:opacity 0.2s;}
.nav-link:hover {opacity:0.8;}
.container {max-width:900px;margin:0 auto;padding:2rem;}
.page-title {font-family:'Fraunces',serif;font-size:2.5rem;color:#1a4d2e;margin-bottom:0.5rem;}
.page-subtitle {color:#52796f;margin-bottom:2rem;font-size:1.1rem;}
.form-card {background:white;border-radius:12px;padding:2rem;box-shadow:0 2px 12px rgba(0,0,0,0.08);margin-bottom:1.5rem;}
.section-title {font-size:1.25rem;font-weight:600;color:#1a4d2e;margin-bottom:1.5rem;padding-bottom:0.75rem;border-bottom:2px solid #d6e4df;}
.form-group {margin-bottom:1.5rem;}
.form-label {display:block;font-weight:600;margin-bottom:0.75rem;color:#1f2421;}
.required {color:#dc3545;}
.help-text {font-size:0.875rem;color:#52796f;margin-top:0.25rem;}
.radio-group,.checkbox-group {display:grid;gap:1rem;}
.radio-option,.checkbox-option {display:flex;align-items:flex-start;padding:1rem;border:2px solid #d6e4df;border-radius:8px;cursor:pointer;transition:all 0.2s;}
.radio-option:hover,.checkbox-option:hover {border-color:#1a4d2e;background:rgba(26,77,46,0.02);}
.radio-option input[type="radio"],.checkbox-option input[type="checkbox"] {margin-right:1rem;width:20px;height:20px;accent-color:#1a4d2e;cursor:pointer;}
.option-content {flex:1;}
.option-title {font-weight:600;margin-bottom:0.25rem;}
.input-field {width:100%;padding:0.75rem;border:2px solid #d6e4df;border-radius:8px;font-size:1rem;font-family:'DM Sans',sans-serif;transition:border-color 0.2s;}
.input-field:focus {outline:none;border-color:#1a4d2e;}
.form-actions {display:flex;gap:1rem;justify-content:flex-end;margin-top:2rem;padding-top:2rem;border-top:2px solid #d6e4df;}
.btn {padding:0.875rem 2rem;border:none;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;transition:all 0.2s;text-decoration:none;display:inline-block;}
.btn-primary {background:#1a4d2e;color:white;}
.btn-primary:hover {background:#2d6a4f;transform:translateY(-2px);box-shadow:0 4px 12px rgba(26,77,46,0.3);}
.btn-secondary {background:#d6e4df;color:#1f2421;}
.btn-secondary:hover {background:#c0d4cc;}
.time-input {font-family:'Courier New',monospace;font-size:1.1rem;text-align:center;letter-spacing:2px;}
.time-input:focus {border-color:#1a4d2e;box-shadow:0 0 5px rgba(26,77,46,0.3);}
</style>
</head>
<body>
<!-- Header -->
<div class="header">
    <div class="header-content">
        <div class="logo">‚è∞ Arbeitszeitverwaltung</div>
        <a href="{% url 'arbeitszeit:dashboard' %}" class="nav-link">‚Üê Zur√ºck zum Dashboard</a>
    </div>
</div>

<div class="container">
<h1 class="page-title">Neue Arbeitszeitvereinbarung</h1>
<p class="page-subtitle">Beantragen Sie eine √Ñnderung Ihrer Arbeitszeit</p>

<form method="post" id="vereinbarung-form">
{% csrf_token %}

<!-- 1. Antragsart -->
<div class="form-card">
<h2 class="section-title">1. Art des Antrags <span class="required">*</span></h2>
<div class="radio-group">
  <label class="radio-option">
    <input type="radio" name="antragsart" value="weiterbewilligung" required>
    <div class="option-content">
      <div class="option-title">‚úì Weiterbewilligung</div>
      <div class="help-text">Verl√§ngerung der bestehenden Vereinbarung</div>
    </div>
  </label>
  <label class="radio-option">
    <input type="radio" name="antragsart" value="verringerung">
    <div class="option-content">
      <div class="option-title">‚Üì Verringerung</div>
      <div class="help-text">Reduzierung der Arbeitszeit</div>
    </div>
  </label>
  <label class="radio-option">
    <input type="radio" name="antragsart" value="erhoehung">
    <div class="option-content">
      <div class="option-title">‚Üë Erh√∂hung</div>
      <div class="help-text">Aufstockung der Arbeitszeit</div>
    </div>
  </label>
  <label class="radio-option">
    <input type="radio" name="antragsart" value="beendigung">
    <div class="option-content">
      <div class="option-title">‚úï Beendigung</div>
      <div class="help-text">Beendigung der aktuellen Vereinbarung</div>
    </div>
  </label>
</div>
</div>

<!-- 2. Arbeitszeit-Typ (nicht f√ºr Beendigung) -->
<div class="form-card" id="arbeitszeit-card">
<h2 class="section-title">2. Art der Arbeitszeitverteilung <span class="required">*</span></h2>
<div class="radio-group">
  <label class="radio-option">
    <input type="radio" name="arbeitszeit_typ" value="regelmaessig" id="radio-regelmaessig">
    <div class="option-content">
      <div class="option-title">üìÖ Regelm√§√üig</div>
      <div class="help-text">Gleiche Stundenzahl jeden Tag</div>
    </div>
  </label>
  <label class="radio-option">
    <input type="radio" name="arbeitszeit_typ" value="individuell" id="radio-individuell">
    <div class="option-content">
      <div class="option-title">üóìÔ∏è Individuell</div>
      <div class="help-text">Unterschiedliche Stunden pro Tag</div>
    </div>
  </label>
</div>

<!-- Regelm√§√üig -->
<div id="regelmaessig-section" >
<div class="form-group">
<label for="wochenstunden" class="form-label">Wochenstunden <span class="required">*</span></label>
<input type="number" id="wochenstunden" name="wochenstunden" class="input-field" min="1" max="48" step="0.5" placeholder="z.B. 40">
<div class="help-text">Anzahl der w√∂chentlichen Arbeitsstunden</div>
</div>
</div>


<!-- Individuell -->
<div id="individuell-section" >
    <p class="help-text">Geben Sie f√ºr jeden Tag die gew√ºnschte Arbeitszeit ein:</p>
    
    <div id="weeks-container">
      <div class="week" data-week="1">
        <div class="week-header">
          <!-- WICHTIG: Hier die Klasse "week-title" hinzuf√ºgen -->
          <h3 class="week-title">Woche 1</h3>
          <button type="button" class="remove-week">‚úï</button>
        </div>
        
        {% for tag in tage_list %}
        <div class="day-input">
            <label class="day-label">{{ tag|capfirst }}</label>
            <input type="time" name="neuantrag_{{ tag }}_1" class="input-field time-input">
        </div>
        {% endfor %}
      </div>
    </div>
    
    <button type="button" id="add-week" class="btn btn-secondary" style="margin-top: 1rem;">+ Woche hinzuf√ºgen</button>
</div>

<!-- 3. G√ºltigkeit / Beendigung -->
<div class="form-card">
<h2 class="section-title" id="gueltigkeits-title">3. G√ºltigkeit</h2>
<div class="form-group">
<label for="datum_input" class="form-label" id="datum-label">G√ºltig ab <span class="required">*</span></label>
<input type="date" id="datum_input" name="gueltig_ab" class="input-field" required>
<div class="help-text" id="datum-help">Datum, ab dem die Vereinbarung g√ºltig ist</div>
</div>
<div class="form-group" id="gueltig-bis-group">
<label for="gueltig_bis" class="form-label">G√ºltig bis (optional)</label>
<input type="date" id="gueltig_bis" name="gueltig_bis" class="input-field">
<div class="help-text">Leer lassen f√ºr unbefristet</div>
</div>
</div>

<!-- 4. Telearbeit -->
<div class="form-card">
<h2 class="section-title">4. Arbeitsort</h2>
<div class="checkbox-group">
<label class="checkbox-option">
<input type="checkbox" name="telearbeit" id="telearbeit">
<div class="option-content">
<div class="option-title">üè† In Telearbeit</div>
<div class="help-text">Teilweise von zu Hause arbeiten</div>
</div>
</label>
</div>
</div>

<!-- Buttons -->
<div class="form-actions">
<a href="{% url 'arbeitszeit:dashboard' %}" class="btn btn-secondary">Abbrechen</a>
<button type="submit" class="btn btn-primary">Vereinbarung beantragen</button>
</div>
</form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  
  // --- 1. Antragsart Toggle (Beendigung vs. Neu) ---
  const antragsartRadios = document.querySelectorAll('input[name="antragsart"]');
  if (antragsartRadios.length > 0) {
      antragsartRadios.forEach(radio => {
        radio.addEventListener('change', function() {
          const arbeitszeitCard = document.getElementById('arbeitszeit-card');
          const gueltigkeitTitle = document.getElementById('gueltigkeits-title');
          const datumLabel = document.getElementById('datum-label');
          const datumHelp = document.getElementById('datum-help');
          const datumInput = document.getElementById('datum_input');
          const gueltigBisGroup = document.getElementById('gueltig-bis-group');

          if (!arbeitszeitCard) return; // Sicherheitscheck

          if (this.value === 'beendigung') {
            arbeitszeitCard.style.display = 'none';
            if(gueltigkeitTitle) gueltigkeitTitle.textContent = '2. Beendigungsdatum';
            if(datumLabel) datumLabel.innerHTML = 'Beendigung zum <span class="required">*</span>';
            if(datumHelp) datumHelp.textContent = 'Datum, zu dem die Vereinbarung beendet werden soll';
            if(gueltigBisGroup) gueltigBisGroup.style.display = 'none';
            if(datumInput) datumInput.name = 'beendigung_datum';
          } else {
            arbeitszeitCard.style.display = 'block';
            if(gueltigkeitTitle) gueltigkeitTitle.textContent = '3. G√ºltigkeit';
            if(datumLabel) datumLabel.innerHTML = 'G√ºltig ab <span class="required">*</span>';
            if(datumHelp) datumHelp.textContent = 'Datum, ab dem die Vereinbarung g√ºltig ist';
            if(gueltigBisGroup) gueltigBisGroup.style.display = 'block';
            if(datumInput) datumInput.name = 'gueltig_ab';
          }
        });
      });
  }

   // --- 2. Arbeitszeit-Typ Toggle (Regelm√§√üig vs. Individuell) ---
  const regelRadio = document.getElementById('radio-regelmaessig');
  const indivRadio = document.getElementById('radio-individuell');
  const regelSection = document.getElementById('regelmaessig-section');
  const indivSection = document.getElementById('individuell-section');

  function toggleArbeitszeit() {
    console.log('Toggle aufgerufen');
    console.log('Regelm√§√üig checked?', regelRadio?.checked);
    console.log('Individuell checked?', indivRadio?.checked);
    
    if (regelRadio && regelRadio.checked) {
      console.log('‚Üí Zeige Regelm√§√üig');
      if(regelSection) {
        regelSection.style.display = 'block';
        regelSection.style.visibility = 'visible';
      }
      if(indivSection) {
        indivSection.style.display = 'none';
        indivSection.style.visibility = 'hidden';
      }
    } else if (indivRadio && indivRadio.checked) {
      console.log('‚Üí Zeige Individuell');
      if(indivSection) {
        indivSection.style.display = 'block';
        indivSection.style.visibility = 'visible';
        console.log('Display gesetzt:', indivSection.style.display);
      }
      if(regelSection) {
        regelSection.style.display = 'none';
        regelSection.style.visibility = 'hidden';
      }
    } else {
      console.log('‚Üí Nichts gecheckt!');
    }
  }
  // ‚Üê HIER FEHLT ES! Event-Listener registrieren:
  if (regelRadio && indivRadio) {
    regelRadio.addEventListener('change', toggleArbeitszeit);
    indivRadio.addEventListener('change', toggleArbeitszeit);
    // Initial ausf√ºhren beim Laden
    toggleArbeitszeit();
  }
  // --- 3. Wochen hinzuf√ºgen Logik ---
  const addWeekBtn = document.getElementById('add-week');
  const weeksContainer = document.getElementById('weeks-container');
  
  // Z√§hler initialisieren basierend auf vorhandenen Wochen
  let weekCount = document.querySelectorAll('.week').length;

  // Erste Woche: L√∂schen-Button ausblenden
  const firstRemoveBtn = document.querySelector('.week .remove-week');
  if (firstRemoveBtn) {
      firstRemoveBtn.style.display = 'none';
  }

  if (addWeekBtn && weeksContainer) {
    addWeekBtn.addEventListener('click', () => {
        weekCount++;
        
        // Die erste Woche als Vorlage nehmen
        const originalWeek = weeksContainer.querySelector('.week');
        const newWeek = originalWeek.cloneNode(true);
        
        // Attribute aktualisieren
        newWeek.dataset.week = weekCount;
        
        // Titel aktualisieren (sucht nach .week-title)
        const titleElement = newWeek.querySelector('.week-title');
        if (titleElement) {
            titleElement.textContent = `Woche ${weekCount}`;
        }
        
        // Inputs bereinigen und Namen aktualisieren
        newWeek.querySelectorAll('input').forEach(input => {
            input.value = ''; // Inhalt leeren
            // Name anpassen: neuantrag_montag_1 -> neuantrag_montag_2
            const parts = input.name.split('_');
            if (parts.length >= 3) {
                // parts[0] = neuantrag, parts[1] = wochentag
                input.name = `${parts[0]}_${parts[1]}_${weekCount}`;
            }
        });

        // L√∂schen-Button f√ºr die neue Woche aktivieren
        const removeBtn = newWeek.querySelector('.remove-week');
        if (removeBtn) {
            removeBtn.style.display = 'inline-block'; // Sichtbar machen
            removeBtn.onclick = function() {
                newWeek.remove();
                // Optional: Nummerierung neu berechnen, hier aber nicht zwingend n√∂tig
            };
        }

        weeksContainer.appendChild(newWeek);
    });
  }
});
</script>
</body>
</html>