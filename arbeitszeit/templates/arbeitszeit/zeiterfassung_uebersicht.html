{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zeituebersicht - Arbeitszeitverwaltung</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Fraunces:wght@600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a4d2e;
            --primary-light: #2d6a4f;
            --accent: #f77f00;
            --bg: #faf9f6;
            --card-bg: #ffffff;
            --text: #1f2421;
            --text-secondary: #52796f;
            --border: #d6e4df;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg);
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--primary);
            font-weight: 700;
        }

        .back-link {
            color: white;
            text-decoration: none;
            font-weight: 500;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .page-title {
            font-family: 'Fraunces', serif;
            font-size: 2rem;
            color: var(--primary);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-block;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-light);
        }

        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg);
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 600;
        }

        /* Tabs Woche / Monat */
        .view-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .view-tab {
            padding: 0.5rem 1.2rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .view-tab:hover {
            border-color: var(--primary-light);
            color: var(--primary);
        }

        .view-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* KW-Navigation */
        .kw-nav {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .kw-nav a {
            text-decoration: none;
            color: var(--primary);
            font-weight: 600;
            font-size: 1.2rem;
            padding: 0.3rem 0.6rem;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .kw-nav a:hover {
            background: var(--border);
        }

        .kw-nav .kw-label {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text);
        }

        .kw-nav .kw-dates {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Monatsfilter */
        .month-filter {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            align-items: center;
        }

        .month-filter select,
        .month-filter input {
            padding: 0.5rem 1rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-family: 'DM Sans', sans-serif;
        }

        /* Tabelle */
        .table-container { overflow-x: auto; }

        table { width: 100%; border-collapse: collapse; }

        th {
            text-align: left;
            padding: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-transform: uppercase;
            border-bottom: 2px solid var(--border);
        }

        td {
            padding: 1rem 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        tr:hover { background: var(--bg); }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-homeoffice { background: #d4edda; color: #155724; }
        .badge-telearbeit { background: #d1ecf1; color: #0c5460; }
        .badge-hybrid { background: #e8daef; color: #6c3483; }
        .badge-buero { background: #fef9e7; color: #7d6608; }
        .badge-urlaub { background: #fff3cd; color: #856404; }
        .badge-krank { background: #f8d7da; color: #721c24; }
        .badge-z_ag { background: #e2e3e5; color: #383d41; }

        .differenz-positiv { color: #155724; font-weight: 600; }
        .differenz-negativ { color: #721c24; font-weight: 600; }
        .differenz-null { color: var(--text-secondary); }

        tfoot td {
            font-weight: 700;
            border-top: 2px solid var(--primary);
            padding: 1rem 0.75rem;
        }

        .row-heute { background: #f0f9f4; }
        .row-wochenende { color: var(--text-secondary); }
        .row-feiertag { background: #fff0f0; }
        .row-feiertag td { color: #a94442; }
        .feiertag-label {
            font-size: 0.75rem;
            color: #a94442;
            font-weight: 600;
            display: block;
        }
        .row-leer td { color: #aab; font-style: italic; }

        .aktionen {
            display: flex;
            gap: 0.3rem;
            justify-content: flex-end;
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            transition: all 0.2s;
            line-height: 1;
        }

        .btn-icon-add {
            background: var(--primary);
            color: white;
        }

        .btn-icon-add:hover {
            background: var(--primary-light);
        }

        .btn-icon-edit {
            background: #ffc107;
            color: #333;
        }

        .btn-icon-edit:hover {
            background: #e0a800;
        }

        .btn-icon-delete {
            background: #dc3545;
            color: white;
        }

        .btn-icon-delete:hover {
            background: #c82333;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--text-secondary);
        }

        @media (max-width: 768px) {
            .page-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
            .kw-nav { flex-wrap: wrap; }
            .month-filter {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">AZ</div>
                <h1>Zeituebersicht</h1>
            </div>
            <a href="{% url 'arbeitszeit:dashboard' %}" class="back-link">&larr; Zurueck</a>
        </div>
    </header>

    <div class="container">
        <div class="page-header">
            <h1 class="page-title">Meine Arbeitszeiten</h1>
            <a href="{% url 'arbeitszeit:zeiterfassung_erstellen' %}" class="btn btn-primary">+ Neue Erfassung</a>
        </div>

        <!-- Tabs: Woche / Monat -->
        <div class="view-tabs">
            <a href="{% url 'arbeitszeit:zeiterfassung_uebersicht' %}?ansicht=woche"
               class="view-tab {% if ansicht == 'woche' %}active{% endif %}">Woche</a>
            <a href="{% url 'arbeitszeit:zeiterfassung_uebersicht' %}?ansicht=monat"
               class="view-tab {% if ansicht == 'monat' %}active{% endif %}">Monat</a>
        </div>

        {% if ansicht == 'woche' %}
            <!-- KW-Navigation -->
            <div class="kw-nav">
                <a href="?ansicht=woche&kw={{ prev_kw }}&jahr={{ prev_jahr }}">&larr;</a>
                <span class="kw-label">KW {{ kw }}</span>
                <span class="kw-dates">{{ montag|date:"d.m." }} - {{ sonntag|date:"d.m.Y" }}</span>
                <a href="?ansicht=woche&kw={{ next_kw }}&jahr={{ next_jahr }}">&rarr;</a>
                {% if wochenbericht %}
                    <a href="{% url 'arbeitszeit:wochenbericht_pdf' %}?kw={{ kw }}&jahr={{ jahr }}"
                       class="btn btn-sm"
                       style="background: #28a745; color: white; margin-left: auto;">
                        PDF ({{ wochenbericht.erstellt_am|date:"d.m." }})
                    </a>
                {% else %}
                    <a href="{% url 'arbeitszeit:wochenbericht_pdf' %}?kw={{ kw }}&jahr={{ jahr }}"
                       class="btn btn-sm"
                       style="background: #6c757d; color: white; margin-left: auto;">
                        PDF erstellen
                    </a>
                {% endif %}
            </div>

            <!-- Stats -->
            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-value">{{ gesamt_soll }}</div>
                    <div class="stat-label">Soll-Stunden</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ gesamt_arbeitszeit }}</div>
                    <div class="stat-label">Ist-Stunden</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value {% if gesamt_differenz >= 0 %}differenz-positiv{% else %}differenz-negativ{% endif %}">
                        {{ gesamt_differenz_formatiert }}
                    </div>
                    <div class="stat-label">Saldo (Ist - Soll)</div>
                </div>
            </div>

            <!-- Wochentabelle -->
            <div class="card">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Tag</th>
                                <th>Datum</th>
                                <th>Von</th>
                                <th>Bis</th>
                                <th>Pause</th>
                                <th>Soll</th>
                                <th>Ist</th>
                                <th>Differenz</th>
                                <th>Art</th>
                                <th style="text-align: right;"></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for tag in wochen_tage %}
                                {% if tag.erfassung %}
                                    <tr class="{% if tag.ist_feiertag %}row-feiertag{% endif %} {% if tag.ist_heute %}row-heute{% endif %} {% if tag.ist_wochenende %}row-wochenende{% endif %}">
                                        <td><strong>{{ tag.wochentag }}</strong></td>
                                        <td>
                                            {{ tag.datum|date:"d.m." }}
                                            {% if tag.ist_feiertag %}
                                                <span class="feiertag-label">{{ tag.feiertag_name }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if tag.erfassung.arbeitsbeginn %}
                                                {{ tag.erfassung.arbeitsbeginn|time:"H:i" }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if tag.erfassung.arbeitsende %}
                                                {{ tag.erfassung.arbeitsende|time:"H:i" }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>{{ tag.erfassung.pause_minuten }} min</td>
                                        <td>{{ tag.soll_formatiert|default:"-" }}</td>
                                        <td>
                                            <strong>{{ tag.erfassung.arbeitszeit_formatiert }}</strong>
                                            {% if tag.erfassung.art == 'hybrid' %}
                                                <span style="font-size: 0.75rem; color: #6c3483; display: block;">Brutto HO</span>
                                            {% elif tag.erfassung.art == 'buero' %}
                                                <span style="font-size: 0.75rem; color: #7d6608; display: block;">Notiz</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if tag.erfassung.art == 'hybrid' or tag.erfassung.art == 'buero' %}
                                                <span style="color: var(--text-secondary); font-size: 0.85rem;">-</span>
                                            {% elif tag.erfassung.soll_minuten != None %}
                                                <span class="{% if tag.erfassung.differenz_minuten > 0 %}differenz-positiv{% elif tag.erfassung.differenz_minuten < 0 %}differenz-negativ{% else %}differenz-null{% endif %}">
                                                    {{ tag.erfassung.differenz_formatiert }}
                                                </span>
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge badge-{{ tag.erfassung.art }}">
                                                {{ tag.erfassung.get_art_display }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="aktionen">
                                                <a href="{% url 'arbeitszeit:zeiterfassung_erstellen' %}?datum={{ tag.datum|date:'Y-m-d' }}"
                                                   class="btn-icon btn-icon-edit" title="Bearbeiten">&#9998;</a>
                                                <form method="post" action="{% url 'arbeitszeit:zeiterfassung_loeschen' tag.erfassung.pk %}"
                                                      style="margin:0;" onsubmit="return confirm('Eintrag loeschen?');">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn-icon btn-icon-delete" title="Loeschen">&times;</button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                {% else %}
                                    <tr class="row-leer {% if tag.ist_feiertag %}row-feiertag{% endif %} {% if tag.ist_heute %}row-heute{% endif %} {% if tag.ist_wochenende %}row-wochenende{% endif %}">
                                        <td><strong>{{ tag.wochentag }}</strong></td>
                                        <td>
                                            {{ tag.datum|date:"d.m." }}
                                            {% if tag.ist_feiertag %}
                                                <span class="feiertag-label">{{ tag.feiertag_name }}</span>
                                            {% endif %}
                                        </td>
                                        <td>-</td>
                                        <td>-</td>
                                        <td>-</td>
                                        <td>{{ tag.soll_formatiert|default:"-" }}</td>
                                        <td>-</td>
                                        <td>-</td>
                                        <td>
                                            {% if tag.ist_feiertag %}
                                                <span class="feiertag-label">Feiertag</span>
                                            {% elif not tag.ist_wochenende %}
                                                <span style="color: var(--text-secondary); font-size: 0.85rem;">nicht erfasst</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if not tag.ist_wochenende and not tag.ist_feiertag %}
                                                <div class="aktionen">
                                                    <a href="{% url 'arbeitszeit:zeiterfassung_erstellen' %}?datum={{ tag.datum|date:'Y-m-d' }}"
                                                       class="btn-icon btn-icon-add" title="Erfassen">+</a>
                                                </div>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endif %}
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="5">Summe KW {{ kw }}</td>
                                <td>{{ gesamt_soll }}</td>
                                <td>{{ gesamt_arbeitszeit }}</td>
                                <td>
                                    <span class="{% if gesamt_differenz >= 0 %}differenz-positiv{% else %}differenz-negativ{% endif %}">
                                        {{ gesamt_differenz_formatiert }}
                                    </span>
                                </td>
                                <td colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

        {% else %}
            <!-- Monatsfilter -->
            <form method="get" class="month-filter">
                <input type="hidden" name="ansicht" value="monat">
                <select name="monat" onchange="this.form.submit()">
                    <option value="1" {% if monat == 1 %}selected{% endif %}>Januar</option>
                    <option value="2" {% if monat == 2 %}selected{% endif %}>Februar</option>
                    <option value="3" {% if monat == 3 %}selected{% endif %}>Maerz</option>
                    <option value="4" {% if monat == 4 %}selected{% endif %}>April</option>
                    <option value="5" {% if monat == 5 %}selected{% endif %}>Mai</option>
                    <option value="6" {% if monat == 6 %}selected{% endif %}>Juni</option>
                    <option value="7" {% if monat == 7 %}selected{% endif %}>Juli</option>
                    <option value="8" {% if monat == 8 %}selected{% endif %}>August</option>
                    <option value="9" {% if monat == 9 %}selected{% endif %}>September</option>
                    <option value="10" {% if monat == 10 %}selected{% endif %}>Oktober</option>
                    <option value="11" {% if monat == 11 %}selected{% endif %}>November</option>
                    <option value="12" {% if monat == 12 %}selected{% endif %}>Dezember</option>
                </select>
                <input type="number" name="jahr" value="{{ jahr }}" min="2020" max="2050" onchange="this.form.submit()">
            </form>

            <!-- Stats -->
            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-value">{{ gesamt_arbeitszeit }}</div>
                    <div class="stat-label">Ist-Stunden</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ erfassungen.count }}</div>
                    <div class="stat-label">Erfasste Tage</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value {% if gesamt_differenz >= 0 %}differenz-positiv{% else %}differenz-negativ{% endif %}">
                        {{ gesamt_differenz_formatiert }}
                    </div>
                    <div class="stat-label">Saldo (Ist - Soll)</div>
                </div>
            </div>

            <!-- Monatstabelle -->
            <div class="card">
                {% if erfassungen %}
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Datum</th>
                                    <th>Von</th>
                                    <th>Bis</th>
                                    <th>Pause</th>
                                    <th>Soll</th>
                                    <th>Ist</th>
                                    <th>Differenz</th>
                                    <th>Art</th>
                                    <th>Bemerkung</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for erfassung in erfassungen %}
                                    <tr class="{% if feiertage_monat|get_item:erfassung.datum %}row-feiertag{% endif %}">
                                        <td>
                                            {{ erfassung.datum|date:"d.m.Y" }}
                                            {% with feiertage_monat|get_item:erfassung.datum as ft_name %}
                                                {% if ft_name %}
                                                    <span class="feiertag-label">{{ ft_name }}</span>
                                                {% endif %}
                                            {% endwith %}
                                        </td>
                                        <td>
                                            {% if erfassung.arbeitsbeginn %}
                                                {{ erfassung.arbeitsbeginn|time:"H:i" }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if erfassung.arbeitsende %}
                                                {{ erfassung.arbeitsende|time:"H:i" }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>{{ erfassung.pause_minuten }} min</td>
                                        <td>{{ erfassung.soll_formatiert|default:"-" }}</td>
                                        <td>
                                            <strong>{{ erfassung.arbeitszeit_formatiert }}</strong>
                                            {% if erfassung.art == 'hybrid' %}
                                                <span style="font-size: 0.75rem; color: #6c3483; display: block;">Brutto HO</span>
                                            {% elif erfassung.art == 'buero' %}
                                                <span style="font-size: 0.75rem; color: #7d6608; display: block;">Notiz</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if erfassung.art == 'hybrid' or erfassung.art == 'buero' %}
                                                <span style="color: var(--text-secondary); font-size: 0.85rem;">-</span>
                                            {% elif erfassung.soll_minuten != None %}
                                                <span class="{% if erfassung.differenz_minuten > 0 %}differenz-positiv{% elif erfassung.differenz_minuten < 0 %}differenz-negativ{% else %}differenz-null{% endif %}">
                                                    {{ erfassung.differenz_formatiert }}
                                                </span>
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge badge-{{ erfassung.art }}">
                                                {{ erfassung.get_art_display }}
                                            </span>
                                        </td>
                                        <td>{{ erfassung.bemerkung|truncatewords:5 }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="5">Summe</td>
                                    <td>{{ gesamt_arbeitszeit }}</td>
                                    <td>
                                        <span class="{% if gesamt_differenz >= 0 %}differenz-positiv{% else %}differenz-negativ{% endif %}">
                                            {{ gesamt_differenz_formatiert }}
                                        </span>
                                    </td>
                                    <td colspan="2"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                {% else %}
                    <div class="empty-state">
                        <h3>Keine Zeiterfassungen</h3>
                        <p style="margin-top: 0.5rem;">Fuer diesen Monat wurden noch keine Zeiten erfasst</p>
                        <a href="{% url 'arbeitszeit:zeiterfassung_erstellen' %}" class="btn btn-primary" style="margin-top: 1.5rem;">
                            Erste Erfassung erstellen
                        </a>
                    </div>
                {% endif %}
            </div>
        {% endif %}
    </div>
</body>
</html>
